<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Apex Precision v51</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Manrope:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #050507; --card: #101014; --primary: #0062ff; --accent: #00f2ff; 
            --success: #0cf387; --warning: #ffb400; --danger: #ff3b30; --border: #222226;
            --text: #ffffff; --text-dim: #808086;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Manrope', sans-serif; overflow-x: hidden; }

        /* --- HEADER --- */
        .nav-header { 
            position: sticky; top: 0; padding: 15px 20px; 
            background: rgba(5, 5, 7, 0.9); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border); display: flex; 
            justify-content: space-between; align-items: center; z-index: 9000;
        }
        .brand { font-weight: 800; font-size: 16px; letter-spacing: 1px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--text); }

        /* --- COMPACT SCANNER --- */
        .scan-area { 
            position: relative; margin: 10px; height: 210px; /* Altura reduzida para mais espaÃ§o */
            border-radius: 24px; overflow: hidden; border: 1px solid var(--border);
            background: #000; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .scan-area.minimized { height: 0; margin: 0; border: none; opacity: 0; }
        
        #reader { width: 100%; height: 100%; transform: scale(1.02); } /* Escala para evitar bordas brancas */
        #reader video { object-fit: cover !important; } /* CORREÃ‡ÃƒO DE Ã‚NGULO */

        .scan-overlay {
            position: absolute; inset: 0; pointer-events: none;
            border: 2px solid transparent; transition: 0.3s; z-index: 10;
        }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            box-shadow: 0 0 15px var(--accent); animation: moveLine 2s infinite linear;
        }
        @keyframes moveLine { 0% { top: 0%; } 100% { top: 100%; } }

        /* --- INPUT MODULE --- */
        .input-card { background: var(--card); margin: 0 10px 10px; padding: 18px; border-radius: 24px; border: 1px solid var(--border); }
        .label-micro { font-size: 10px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; display: block; }
        
        .row-input { display: flex; gap: 10px; margin-bottom: 12px; }
        input { 
            background: #000; border: 1px solid var(--border); border-radius: 14px; 
            color: #fff; padding: 14px 18px; font-family: 'JetBrains Mono', monospace; font-size: 15px; width: 100%;
        }
        input:focus { border-color: var(--primary); }

        .btn-action { 
            background: var(--primary); color: #fff; border: none; border-radius: 14px;
            padding: 0 25px; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.95); }

        /* --- SEARCH & LIST --- */
        .list-controls { padding: 0 15px 10px; display: flex; align-items: center; gap: 10px; }
        .search-bar { background: var(--card); border: 1px solid var(--border); padding: 8px 15px; border-radius: 10px; flex: 1; color: #fff; font-size: 13px; }

        .items-scroll { padding: 0 10px 320px; }
        .item-tile { 
            background: var(--card); padding: 15px 18px; border-radius: 18px; 
            margin-bottom: 8px; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            animation: fadeIn 0.3s ease;
        }
        .item-main b { display: block; font-size: 14px; margin-bottom: 2px; }
        .item-main small { color: var(--text-dim); font-size: 11px; font-family: 'JetBrains Mono'; }
        .item-val { background: rgba(0, 98, 255, 0.1); color: var(--primary); padding: 8px 12px; border-radius: 10px; font-weight: 800; font-family: 'JetBrains Mono'; border: 1px solid rgba(0, 98, 255, 0.2); }

        /* --- DASHBOARD --- */
        .stats-hud { 
            position: fixed; bottom: 0; inset-x: 0; background: rgba(16, 16, 20, 0.95); 
            backdrop-filter: blur(30px); border-top: 1px solid var(--border);
            padding: 20px 20px 40px; border-radius: 30px 30px 0 0;
        }
        .stat-flex { display: flex; justify-content: space-between; margin-bottom: 20px; text-align: center; }
        .stat-item span { display: block; font-size: 10px; color: var(--text-dim); font-weight: 800; margin-bottom: 4px; }
        .stat-item b { font-size: 22px; font-family: 'JetBrains Mono'; color: var(--accent); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<audio id="beep" src="https://raw.githubusercontent.com/isaque-prussak/coletor/main/beep.mp3" preload="auto"></audio>
<input type="file" id="catalog-file" style="display:none" onchange="apex.load(this)">

<div id="start-screen" style="position:fixed; inset:0; z-index:10000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px;">
    <div style="width:50px; height:50px; background:var(--primary); border-radius:12px; transform:rotate(45deg); margin-bottom:20px; box-shadow:0 0 20px var(--primary);"></div>
    <h1 style="font-weight:800; font-size:24px; margin:0;">APEX <span>PRECISION</span></h1>
    <p style="color:var(--text-dim); font-size:12px; margin:10px 0 40px;">v51.0 ENTERPRISE TERMINAL</p>
    
    <button onclick="apex.start('INVENTARIO')" class="btn-action" style="height:60px; width:100%; margin-bottom:15px; border-radius:20px;">INICIAR OPERAÃ‡ÃƒO</button>
    <button onclick="document.getElementById('catalog-file').click()" style="background:none; border:none; color:var(--text-dim); font-size:12px; font-weight:700;">IMPORTAR PRODUTO.TXT</button>
</div>

<div id="main-app" style="display:none;">
    <header class="nav-header">
        <div class="brand">APEX <span>PRECISION</span></div>
        <button id="toggle-cam" onclick="apex.toggleCam()" style="background:var(--primary); border:none; color:white; font-size:10px; font-weight:800; padding:8px 15px; border-radius:10px;">CAM ON</button>
    </header>

    <div class="scan-area" id="scan-wrap">
        <div class="scan-overlay" id="ovl"><div class="scan-line"></div></div>
        <div id="reader"></div>
        <div style="position:absolute; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; z-index:20;">
            <button onclick="apex.flip()" style="background:rgba(0,0,0,0.6); border:1px solid var(--border); color:white; padding:8px 12px; border-radius:10px; font-size:12px;">ðŸ”„ Inverter</button>
            <button onclick="apex.torch()" style="background:rgba(0,0,0,0.6); border:1px solid var(--border); color:white; padding:8px 12px; border-radius:10px; font-size:12px;">ðŸ”¦ Flash</button>
        </div>
    </div>

    <div class="input-card">
        <span class="label-micro" id="prod-desc">Aguardando Leitura...</span>
        <div class="row-input">
            <input type="text" id="bc-in" placeholder="CÃ³digo de Barras" oninput="apex.check(this.value)">
        </div>
        <div class="row-input">
            <input type="text" id="qty-in" value="1.000" inputmode="decimal" onfocus="this.select()">
            <button class="btn-action" onclick="apex.add()">SALVAR</button>
        </div>
    </div>

    <div class="list-controls">
        <input type="text" class="search-bar" placeholder="ðŸ” Filtrar na lista..." oninput="apex.filter(this.value)">
    </div>

    <div class="items-scroll" id="list-render"></div>

    <footer class="stats-hud">
        <div class="stat-flex">
            <div class="stat-item"><span>LINHAS</span><b id="st-skus">0</b></div>
            <div class="stat-item"><span>TOTAL UNID.</span><b id="st-units">0.000</b></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="apex.export()" style="flex:1; background:var(--card); border:1px solid var(--border); color:white; padding:15px; border-radius:15px; font-weight:800; font-size:13px;">EXPORTAR TXT</button>
            <button onclick="apex.zap()" style="flex:1; background:#25d366; border:none; color:white; padding:15px; border-radius:15px; font-weight:800; font-size:13px;">WHATSAPP</button>
        </div>
    </footer>
</div>

<script>
    const apex = {
        db: JSON.parse(localStorage.getItem('apex_v51_db')) || [],
        catalog: [], active: null, isPaused: false, camOn: true, light: false,
        hw: { scanner: null, list: [], idx: 0 },

        async init() {
            try {
                const r = await fetch('PRODUTO.TXT');
                if(r.ok) this.parse(await r.text());
            } catch(e) {}
            this.render();
        },

        parse(t) {
            this.catalog = t.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                c: l.substring(0, 13).trim().padStart(13, '0'),
                n: l.substring(13).slice(0, -10).trim()
            }));
        },

        load(i) {
            const r = new FileReader();
            r.onload = (e) => { this.parse(e.target.result); alert("CATÃLOGO OK"); };
            r.readAsText(i.files[0]);
        },

        start(m) {
            this.mode = m;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            this.initCam();
        },

        toggleCam() {
            this.camOn = !this.camOn;
            const wrap = document.getElementById('scan-wrap');
            const btn = document.getElementById('toggle-cam');
            if(this.camOn) {
                wrap.classList.remove('minimized');
                btn.innerText = "CAM ON"; btn.style.background = "var(--primary)";
                this.initCam();
            } else {
                wrap.classList.add('minimized');
                btn.innerText = "CAM OFF"; btn.style.background = "#222";
                if(this.hw.scanner) this.hw.scanner.stop();
            }
        },

        initCam() {
            Html5Qrcode.getCameras().then(d => {
                this.hw.list = d.filter(c => /back|traseira|0/i.test(c.label)) || d;
                this.run(this.hw.list[this.hw.idx].id);
            });
        },

        run(id) {
            if(this.hw.scanner) this.hw.scanner.stop().then(() => this.exec(id));
            else this.exec(id);
        },

        exec(id) {
            this.hw.scanner = new Html5Qrcode("reader");
            // CONFIGURAÃ‡ÃƒO DE PRECISÃƒO: Sem aspectRatio fixo para evitar distorÃ§Ã£o
            this.hw.scanner.start(id, { fps: 30, qrbox: {width: 220, height: 130} }, (t) => {
                if(this.isPaused) return;
                this.isPaused = true;
                this.feedback();
                let code = t.replace(/[^0-9]/g, "").padStart(13, '0');
                document.getElementById('bc-in').value = code;
                this.check(code);
                document.getElementById('qty-in').focus();
            });
        },

        check(v) {
            const ovl = document.getElementById('ovl');
            if(!v) {
                this.isPaused = false;
                ovl.style.borderColor = "transparent";
                document.getElementById('prod-desc').innerText = "Aguardando Leitura...";
                return;
            }
            let c = v.trim().padStart(13, '0');
            const hit = this.catalog.find(i => i.c === c);
            this.active = hit || { c: c, n: "NÃƒO CADASTRADO" };
            
            document.getElementById('prod-desc').innerText = this.active.n;
            ovl.style.borderColor = hit ? "var(--success)" : "var(--warning)";
            document.getElementById('prod-desc').style.color = hit ? "var(--success)" : "var(--warning)";
        },

        add() {
            const c = document.getElementById('bc-in').value.trim().padStart(13, '0');
            const q = parseFloat(document.getElementById('qty-in').value.replace(',','.'));
            if(!c || isNaN(q)) return;

            const idx = this.db.findIndex(i => i.c === c);
            if(idx !== -1) this.db[idx].q = (parseFloat(this.db[idx].q) + q).toFixed(3);
            else this.db.push({ c, n: this.active ? this.active.n : "AVULSO", q: q.toFixed(3) });

            this.persist();
            this.reset();
        },

        persist() {
            localStorage.setItem('apex_v51_db', JSON.stringify(this.db));
            this.render();
        },

        render(data = null) {
            const source = data || this.db;
            let total = 0;
            const html = source.map((it, i) => {
                total += parseFloat(it.q);
                return `<div class="item-tile">
                    <div class="item-main">
                        <b>${it.n}</b>
                        <small>${it.c}</small>
                    </div>
                    <div class="item-val" onclick="apex.edit('${it.c}')">${it.q}</div>
                    <button onclick="apex.del('${it.c}')" style="background:none; border:none; color:var(--danger); margin-left:10px; font-weight:800;">âœ•</button>
                </div>`;
            }).reverse().join('');
            
            document.getElementById('list-render').innerHTML = html;
            document.getElementById('st-skus').innerText = source.length;
            document.getElementById('st-units').innerText = total.toFixed(3);
        },

        filter(query) {
            const filtered = this.db.filter(i => i.n.toLowerCase().includes(query.toLowerCase()) || i.c.includes(query));
            this.render(filtered);
        },

        reset() {
            document.getElementById('bc-in').value = "";
            document.getElementById('qty-in').value = "1.000";
            this.check("");
            document.getElementById('bc-in').focus();
        },

        edit(code) {
            const idx = this.db.findIndex(i => i.c === code);
            const v = prompt("EDITAR QTD:", this.db[idx].q);
            if(v) { this.db[idx].q = parseFloat(v.replace(',','.')).toFixed(3); this.persist(); }
        },

        del(code) {
            if(confirm("REMOVER ITEM?")) {
                this.db = this.db.filter(i => i.c !== code);
                this.persist();
            }
        },

        feedback() {
            document.getElementById('beep').play().catch(()=>{});
            if(navigator.vibrate) navigator.vibrate(100);
        },

        torch() {
            this.light = !this.light;
            if(this.hw.scanner) this.hw.scanner.applyVideoConstraints({ advanced: [{torch: this.light}] });
        },

        flip() {
            this.hw.idx = (this.hw.idx + 1) % this.hw.list.length;
            this.run(this.hw.list[this.hw.idx].id);
        },

        export() {
            const pre = this.mode === 'INVENTARIO' ? 'Inventario ' : '';
            const txt = this.db.map(i => `${pre}${i.c} ${i.q}`).join("\r\n");
            const b = new Blob([txt], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `APEX_PRECISION_${Date.now()}.txt`;
            a.click();
        },

        async zap() {
            const pre = this.mode === 'INVENTARIO' ? 'Inventario ' : '';
            const txt = this.db.map(i => `${pre}${i.c} ${i.q}`).join("\r\n");
            const f = new File([txt], 'apex_data.txt', {type:'text/plain'});
            if(navigator.share) await navigator.share({ files: [f] });
        }
    };
    window.onload = () => apex.init();
</script>
</body>
</html>
