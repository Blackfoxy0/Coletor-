<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <title>Apex Collector</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #0a0a0f; --card: #16161f; --primary: #0070f3; --accent: #00dfd8; 
            --success: #00ff88; --danger: #ff0055; --border: rgba(255, 255, 255, 0.05); 
            --text: #f0f0f0; --glass: rgba(255, 255, 255, 0.02);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; }
        html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        /* LOGO APEX */
        .apex-logo { font-weight: 800; font-size: 24px; letter-spacing: -1px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .apex-icon { width: 30px; height: 30px; background: linear-gradient(135deg, var(--primary), var(--accent)); clip-path: polygon(50% 0%, 100% 100%, 0% 100%); }

        /* INTERFACE */
        #menu-inicial { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .menu-card { background: var(--card); border: 1px solid var(--border); padding: 40px; border-radius: 40px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        .btn { width: 100%; padding: 20px; border-radius: 20px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; color: white; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--primary); box-shadow: 0 10px 20px -5px rgba(0, 112, 243, 0.3); }
        .btn-outline { background: var(--glass); border: 1px solid var(--border); color: #888; }
        .btn:active { transform: scale(0.96); }

        /* APP LAYOUT */
        #app-container { display: none; flex-direction: column; }
        .header { position: sticky; top: 0; padding: 15px 20px; border-bottom: 1px solid var(--border); background: rgba(10,10,15,0.8); backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; z-index: 5000; }

        /* CAMERA MINIMIZAVEL */
        .scanner-container { position: relative; margin: 12px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); height: 250px; opacity: 1; }
        .scanner-container.minimized { height: 0; margin: 0; opacity: 0; pointer-events: none; overflow: hidden; }
        .scanner-frame { position: relative; border-radius: 30px; overflow: hidden; border: 2px solid var(--border); background: #000; height: 100%; }
        .scanner-success { border-color: var(--success) !important; box-shadow: 0 0 30px rgba(0, 255, 136, 0.3); }

        /* CONTROLES FLUTUANTES */
        .floating-controls { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px; z-index: 100; }
        .btn-round { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(0,0,0,0.5); color: white; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; font-size: 18px; border: 1px solid rgba(255,255,255,0.1); }

        /* PAINEL DE ENTRADA */
        .entry-panel { background: var(--card); border-radius: 35px; padding: 25px; margin: 0 12px 15px; border: 1px solid var(--border); }
        .status-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; margin-bottom: 5px; display: block; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 20px; background: rgba(0,0,0,0.2); border: 2px solid transparent; border-radius: 20px; color: #fff; font-size: 17px; font-weight: 600; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: rgba(0,0,0,0.4); }
        
        .btn-clear { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 35px; height: 35px; border-radius: 12px; background: rgba(255,255,255,0.05); border: none; color: #666; font-size: 12px; }

        /* LISTA PROFISSIONAL */
        #lista-corpo { padding: 0 15px 350px; }
        .item-card { background: var(--card); padding: 18px; border-radius: 25px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid var(--border); animation: reveal 0.4s ease; }
        .item-info { flex: 1; }
        .item-name { font-weight: 700; font-size: 14px; color: var(--text); display: block; margin-bottom: 2px; }
        .item-code { font-size: 11px; color: #555; font-weight: 600; }
        .item-qty-trigger { background: var(--glass); padding: 10px 18px; border-radius: 15px; color: var(--accent); font-weight: 800; font-size: 16px; border: 1px solid var(--border); }

        /* DASHBOARD INFERIOR */
        .dashboard { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(30px); padding: 25px; border-top: 1px solid var(--border); z-index: 5000; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-label { font-size: 10px; color: #555; font-weight: 800; text-transform: uppercase; display: block; }
        .stat-value { font-size: 18px; font-weight: 800; color: var(--text); }

        @keyframes reveal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<audio id="beep-sound" src="https://raw.githubusercontent.com/isaque-prussak/coletor/main/beep.mp3" preload="auto"></audio>
<input type="file" id="file-input" style="display:none" accept=".txt" onchange="apex.loadLocalFile(this)">

<div id="menu-inicial">
    <div class="menu-card">
        <div class="apex-logo">
            <div class="apex-icon"></div>
            APEX COLLECTOR
        </div>
        <p style="color:#444; font-size:11px; font-weight:700; margin: 10px 0 40px;">INDUSTRIAL PRECISION V41.0</p>
        
        <button class="btn btn-primary" onclick="apex.start('INVENTARIO')">INICIAR INVENT√ÅRIO</button>
        <button class="btn btn-outline" onclick="apex.start('TROCA')">MODO TROCA / QUEBRA</button>
        
        <button class="btn" style="background:none; border:1px dashed #333; color:#555; font-size:12px; margin-top:20px" onclick="document.getElementById('file-input').click()">
            üìÇ CARREGAR CAT√ÅLOGO TXT
        </button>
    </div>
</div>

<div id="app-container">
    <div class="header">
        <button onclick="apex.toMenu()" style="background:none; border:none; color:#555; font-weight:800; font-size:11px;">‚¨Ö MENU</button>
        <div class="apex-logo" style="font-size:16px;">
            <div class="apex-icon" style="width:18px; height:18px;"></div>
            APEX
        </div>
        <button onclick="apex.toggleCam()" id="btn-min-cam" style="background:var(--primary); border:none; color:white; font-weight:800; font-size:10px; padding:8px 15px; border-radius:10px;">C√ÇMERA: ON</button>
    </div>

    <div class="scanner-container" id="sc-cont">
        <div class="scanner-frame" id="frame-cam">
            <div id="reader"></div>
            <div class="floating-controls">
                <button class="btn-round" onclick="apex.cycleCam()">üîÑ</button>
            </div>
        </div>
    </div>
    
    <div class="entry-panel">
        <span class="status-tag" id="p-nome">Aguardando...</span>
        <div class="input-group">
            <input type="text" id="barcode-res" placeholder="Escaneie ou Digite" oninput="apex.onInput(this.value)" autocomplete="off">
            <button class="btn-clear" onclick="apex.clearIn()">‚úï</button>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="qtd" value="1.000" inputmode="decimal" style="flex:1" onfocus="this.select()">
            <button class="btn btn-primary" style="flex:1.5; margin:0;" onclick="apex.addItem()">REGISTRAR</button>
        </div>
    </div>

    <div id="lista-corpo"></div>

    <div class="dashboard">
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">Total SKUs</span>
                <span class="stat-value" id="st-skus">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Itens Coletados</span>
                <span class="stat-value" id="st-total" style="color:var(--accent)">0.000</span>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn" style="background:#222; flex:1; margin:0;" onclick="apex.exportTxt()">üíæ TXT</button>
            <button class="btn" style="background:#25d366; flex:1; margin:0;" onclick="apex.shareZap()">üü¢ WHATSAPP</button>
        </div>
        <button onclick="apex.clearAll()" style="width:100%; background:none; border:none; color:var(--danger); font-size:10px; font-weight:800; margin-top:15px; opacity:0.5; letter-spacing:1px;">LIMPAR BANCO DE DADOS</button>
    </div>
</div>

<script>
    const apex = {
        state: {
            mode: 'INVENTARIO',
            db: JSON.parse(localStorage.getItem('apex_db')) || [],
            catalog: [],
            activeProd: null,
            paused: false,
            camVisible: true
        },
        hw: { scanner: null, cams: [], idx: 0 },

        init() {
            this.loadAutoCatalog();
            this.render();
        },

        loadAutoCatalog: async function() {
            try {
                const r = await fetch('PRODUTO.TXT');
                if(r.ok) this.parseCatalog(await r.text());
            } catch(e) { console.log("Catalog: Offline Mode"); }
        },

        loadLocalFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.parseCatalog(e.target.result);
                alert("Cat√°logo Apex Sincronizado!");
            };
            reader.readAsText(input.files[0]);
        },

        parseCatalog(txt) {
            this.state.catalog = txt.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                c: l.substring(0, 13).trim().padStart(13, '0'),
                n: l.substring(13).slice(0, -10).trim()
            }));
        },

        start(m) {
            this.state.mode = m;
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            this.initCam();
        },

        toggleCam() {
            this.state.camVisible = !this.state.camVisible;
            const cont = document.getElementById('sc-cont');
            const btn = document.getElementById('btn-min-cam');
            if(this.state.camVisible) {
                cont.classList.remove('minimized');
                btn.innerText = "C√ÇMERA: ON";
                btn.style.background = "var(--primary)";
                this.initCam();
            } else {
                cont.classList.add('minimized');
                btn.innerText = "C√ÇMERA: OFF";
                btn.style.background = "#222";
                if(this.hw.scanner) this.hw.scanner.stop();
            }
        },

        initCam() {
            Html5Qrcode.getCameras().then(devs => {
                this.hw.cams = devs.filter(d => /back|traseira|0/i.test(d.label));
                if(this.hw.cams.length === 0) this.hw.cams = devs;
                this.runCam(this.hw.cams[this.hw.idx].id);
            });
        },

        runCam(id) {
            if(this.hw.scanner) this.hw.scanner.stop().then(() => this.exec(id));
            else this.exec(id);
        },

        exec(id) {
            this.hw.scanner = new Html5Qrcode("reader");
            this.hw.scanner.start(id, { fps: 24, qrbox: 250 }, (t) => {
                if(this.state.paused) return;
                this.state.paused = true;
                this.feedback();
                document.getElementById('frame-cam').classList.add('scanner-success');
                let code = t.replace(/[^0-9]/g, "").padStart(13, '0');
                document.getElementById('barcode-res').value = code;
                this.onInput(code);
                document.getElementById('qtd').focus(); document.getElementById('qtd').select();
            });
        },

        onInput(v) {
            if(v.length === 0) {
                this.state.paused = false;
                document.getElementById('frame-cam').className = 'scanner-frame';
                document.getElementById('p-nome').innerText = "Aguardando...";
                this.state.activeProd = null;
            } else {
                let code = v.trim().padStart(13, '0');
                const hit = this.state.catalog.find(i => i.c === code);
                this.state.activeProd = hit || { c: code, n: "PRODUTO N√ÉO CADASTRADO" };
                document.getElementById('p-nome').innerText = this.state.activeProd.n;
            }
        },

        addItem() {
            const code = document.getElementById('barcode-res').value.trim().padStart(13, '0');
            const qty = parseFloat(document.getElementById('qtd').value.replace(',','.'));
            if(!code || isNaN(qty)) return;

            const existing = this.state.db.find(i => i.c === code);
            if(existing) {
                existing.q = (parseFloat(existing.q) + qty).toFixed(3);
            } else {
                this.state.db.push({ 
                    c: code, 
                    n: this.state.activeProd ? this.state.activeProd.n : "AVULSO", 
                    q: qty.toFixed(3) 
                });
            }
            this.save();
            this.clearIn();
        },

        save() {
            localStorage.setItem('apex_db', JSON.stringify(this.state.db));
            this.render();
        },

        render() {
            let total = 0;
            const html = this.state.db.map((item, i) => {
                total += parseFloat(item.q);
                return `
                <div class="item-card">
                    <div class="item-info">
                        <span class="item-name">${item.n}</span>
                        <span class="item-code">${item.c}</span>
                    </div>
                    <div class="item-qty-trigger" onclick="apex.edit(${i})">${item.q}</div>
                    <button onclick="apex.remove(${i})" style="background:none; border:none; color:var(--danger); margin-left:15px; font-weight:800;">‚úï</button>
                </div>`;
            }).reverse().join('');
            
            document.getElementById('lista-corpo').innerHTML = html;
            document.getElementById('st-skus').innerText = this.state.db.length;
            document.getElementById('st-total').innerText = total.toFixed(3);
        },

        edit(i) {
            const n = prompt("Nova quantidade:", this.state.db[i].q);
            if(n !== null && !isNaN(parseFloat(n))) {
                this.state.db[i].q = parseFloat(n.replace(',','.')).toFixed(3);
                this.save();
            }
        },

        remove(i) { if(confirm("Remover item?")) { this.state.db.splice(i,1); this.save(); } },

        clearIn() {
            document.getElementById('barcode-res').value = "";
            document.getElementById('qtd').value = "1.000";
            this.onInput("");
            document.getElementById('barcode-res').focus();
        },

        feedback() {
            const aud = document.getElementById('beep-sound');
            if(aud) { aud.currentTime = 0; aud.play().catch(()=>{}); }
            if(navigator.vibrate) navigator.vibrate(150);
        },

        exportTxt() {
            if(this.state.db.length === 0) return;
            const content = this.state.db.map(i => `${this.state.mode === 'INVENTARIO' ? 'Inventario ' : ''}${i.c} ${i.q}`).join("\r\n");
            const blob = new Blob([content], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `APEX_${this.state.mode}.txt`;
            a.click();
            setTimeout(() => this.postExport(), 1000);
        },

        async shareZap() {
            if(this.state.db.length === 0) return;
            const content = this.state.db.map(i => `${this.state.mode === 'INVENTARIO' ? 'Inventario ' : ''}${i.c} ${i.q}`).join("\r\n");
            const file = new File([content], 'apex_data.txt', {type: 'text/plain'});
            if(navigator.share) {
                await navigator.share({ files: [file] });
                this.postExport();
            }
        },

        postExport() {
            if(confirm("Dados salvos. Limpar lista atual?")) this.clearAll();
        },

        clearAll() {
            this.state.db = [];
            this.save();
        },

        toMenu() {
            if(this.hw.scanner) this.hw.scanner.stop();
            document.getElementById('menu-inicial').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    };

    window.onload = () => apex.init();
</script>
</body>
</html>
