<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APEX TITANIUM v180</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #3b82f6; --bg: #000; --surface: #0a0a0b; --surface-2: #161618;
            --text: #fff; --mute: #6b7280; --border: #1e1e20; --success: #10b981; --error: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* INTRO */
        #intro-screen { position: fixed; inset: 0; background: #000; z-index: 10001; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.8s; }
        .intro-logo { font-family: 'Orbitron'; font-size: 42px; color: var(--brand); letter-spacing: 12px; text-shadow: 0 0 30px var(--brand); }
        
        /* HEADER */
        header { padding: 50px 20px 10px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }

        /* VIEWPORT FULL WIDTH */
        .viewport-wrapper { position: relative; width: 100%; height: 40vh; background: #000; border-bottom: 2px solid var(--brand); }
        #reader { width: 100% !important; height: 100% !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }

        /* CONTROLES DA C√ÇMERA */
        .cam-controls { position: absolute; right: 15px; top: 15px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .btn-cam-action { background: rgba(0,0,0,0.6); border: 1px solid var(--brand); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(5px); }

        .scan-overlay { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .laser-line { width: 100%; height: 2px; background: var(--brand); box-shadow: 0 0 20px var(--brand); animation: scanLine 2s infinite ease-in-out; }
        @keyframes scanLine { 0%, 100% { transform: translateY(-60px); opacity: 0.2; } 50% { transform: translateY(60px); opacity: 1; } }

        .slogan-box { position: absolute; bottom: 15px; width: 100%; text-align: center; z-index: 11; }
        .slogan-text { font-size: 9px; letter-spacing: 4px; color: var(--brand); font-weight: 900; text-transform: uppercase; text-shadow: 0 0 10px var(--brand); }

        /* PAINEL */
        .panel { flex: 1; padding: 20px; background: var(--bg); overflow-y: auto; }
        .card { background: var(--surface); padding: 20px; border-radius: 25px; border: 1px solid var(--border); }
        .row { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px; }
        input { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; color: #fff; text-align: center; font-size: 20px; font-weight: 700; }
        
        .btn-add { background: var(--brand); color: #fff; border: none; padding: 18px; border-radius: 15px; font-weight: 900; width: 100%; font-size: 14px; text-transform: uppercase; }
        
        .tools { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-t { background: var(--surface-2); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 10px; font-size: 9px; font-weight: 800; }

        /* LISTA */
        .log { margin-top: 20px; }
        .item { background: var(--surface); padding: 12px 15px; border-radius: 18px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .qty { background: var(--brand); width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin-right: 12px; font-size: 12px; }

        #gate { position: fixed; inset: 0; z-index: 10002; background: #000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="App.initAudio()">

    <div id="gate">
        <button class="btn-add" style="width:auto; padding: 20px 40px;">INICIAR APEX v180</button>
    </div>

    <div id="intro-screen" style="display:none;">
        <div class="intro-logo">APEX</div>
        <div class="slogan-text" style="margin-top:20px; color:var(--mute)">Inova√ß√£o em Movimento</div>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100vh;">
        <header>
            <div style="font-family:'Orbitron'; font-size:16px;">APEX <span style="color:var(--brand)">TITANIUM</span></div>
            <div id="status-cam" style="font-size:8px; color:var(--mute)">CAM: DEFAULT</div>
        </header>

        <div class="viewport-wrapper">
            <div id="reader"></div>
            <div class="cam-controls">
                <button class="btn-cam-action" onclick="App.switchCamera()" title="Trocar C√¢mera">üîÑ</button>
            </div>
            <div class="scan-overlay">
                <div class="laser-line"></div>
            </div>
            <div class="slogan-box">
                <div class="slogan-text">Inova√ß√£o em Movimento</div>
            </div>
        </div>

        <div class="panel">
            <div class="card">
                <div id="p-name" style="text-align:center; color:var(--brand); font-weight:900; font-size:13px; margin-bottom:12px; height:15px;">AGUARDANDO...</div>
                <div class="row">
                    <input type="text" id="p-code" placeholder="C√ìDIGO" oninput="App.checkCat(this.value)">
                    <input type="number" id="p-qty" value="1">
                </div>
                <button class="btn-add" onclick="App.manualAdd()">REGISTRAR ITEM</button>
                
                <div class="tools">
                    <button class="btn-t" onclick="document.getElementById('f').click()">CAT√ÅLOGO</button>
                    <button class="btn-t" onclick="App.export()">EXPORTAR</button>
                    <button class="btn-t" style="color:var(--error)" onclick="App.clear()">LIMPAR</button>
                </div>
                <input type="file" id="f" style="display:none" accept=".csv,.txt" onchange="App.importCat(event)">
            </div>

            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const App = {
            db: JSON.parse(localStorage.getItem('apex_v180_db')) || [],
            cat: JSON.parse(localStorage.getItem('apex_v180_cat')) || {},
            ctx: null,
            scanner: null,
            cameras: [],
            currentCamIdx: 0,

            initAudio() {
                if(this.ctx) return;
                document.getElementById('gate').style.display = 'none';
                document.getElementById('intro-screen').style.display = 'flex';
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                setTimeout(() => {
                    document.getElementById('intro-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('intro-screen').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';
                        this.initScanner();
                        this.render();
                    }, 600);
                }, 1800);
            },

            async initScanner() {
                try {
                    this.cameras = await Html5Qrcode.getCameras();
                    if (this.cameras && this.cameras.length > 0) {
                        this.startCam(this.cameras[this.currentCamIdx].id);
                    } else {
                        alert("C√¢mera n√£o detectada.");
                    }
                } catch (e) { alert("Erro ao acessar hardware."); }
            },

            async startCam(cameraId) {
                if(this.scanner) await this.scanner.stop();
                this.scanner = new Html5Qrcode("reader");
                const config = { 
                    fps: 30, 
                    qrbox: { width: 320, height: 180 },
                    aspectRatio: 1.777778 // 16:9 para aproveitar a largura
                };
                
                await this.scanner.start(cameraId, config, (val) => {
                    document.getElementById('p-code').value = val;
                    this.checkCat(val);
                    if(navigator.vibrate) navigator.vibrate(60);
                    this.addItem(val);
                });
                document.getElementById('status-cam').innerText = `CAM ACTIVE: ${this.currentCamIdx + 1}`;
            },

            async switchCamera() {
                if(this.cameras.length < 2) return alert("Apenas uma c√¢mera detectada.");
                this.currentCamIdx = (this.currentCamIdx + 1) % this.cameras.length;
                await this.startCam(this.cameras[this.currentCamIdx].id);
            },

            importCat(e) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n');
                    this.cat = {};
                    lines.forEach(l => {
                        const [c, n] = l.split(',');
                        if(c && n) this.cat[c.trim()] = n.trim();
                    });
                    localStorage.setItem('apex_v180_cat', JSON.stringify(this.cat));
                    alert("Cat√°logo Pronto!");
                };
                reader.readAsText(e.target.files[0]);
            },

            checkCat(c) {
                const name = this.cat[c] || "NOVO ITEM";
                document.getElementById('p-name').innerText = name;
                return name;
            },

            addItem(code) {
                const qty = parseInt(document.getElementById('p-qty').value) || 1;
                const exists = this.db.find(i => i.code === code);
                if(exists) exists.qty += qty;
                else this.db.unshift({ code, name: this.cat[code] || "Novo", qty, time: new Date().toLocaleTimeString() });
                this.save();
            },

            manualAdd() {
                const c = document.getElementById('p-code').value;
                if(c) { this.addItem(c); document.getElementById('p-code').value = ""; }
            },

            save() { localStorage.setItem('apex_v180_db', JSON.stringify(this.db)); this.render(); },
            clear() { if(confirm("Limpar tudo?")) { this.db = []; this.save(); } },

            export() {
                let txt = "APEX DATA\nCOD,NOME,QTD,HORA\n";
                this.db.forEach(i => txt += `${i.code},${i.name},${i.qty},${i.time}\n`);
                const b = new Blob([txt], {type:'text/plain'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b);
                a.download = "COLETA.txt"; a.click();
            },

            render() {
                document.getElementById('log').innerHTML = this.db.map(i => `
                    <div class="item">
                        <div style="display:flex; align-items:center">
                            <div class="qty">${i.qty}</div>
                            <div>
                                <div style="font-weight:900; font-size:13px">${i.name}</div>
                                <div style="font-size:10px; color:var(--mute)">${i.code}</div>
                            </div>
                        </div>
                        <button onclick="App.db=App.db.filter(x=>x.code!='${i.code}');App.save()" style="background:none; border:none; color:var(--error)">‚úï</button>
                    </div>
                `).join('');
            }
        };
    </script>
</body>
</html>
