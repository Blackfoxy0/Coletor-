<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coletor Pro v16.4</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #000; --card: #111; --primary: #fff; --accent: #3b82f6; --border: #222; --success: #10b981; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--primary); padding-bottom: 280px; }
        .header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid var(--border); font-size: 13px; }
        .container { padding: 12px; max-width: 500px; margin: auto; }
        .scanner-card { background: #000; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); aspect-ratio: 1/1; position: relative; }
        #reader { width: 100%; height: 100%; }
        .panel { background: var(--card); border-radius: 24px; padding: 20px; margin-top: -40px; position: relative; z-index: 100; border: 1px solid var(--border); }
        .product-name-display { color: var(--accent); font-weight: bold; font-size: 14px; margin-bottom: 12px; text-align: center; border: 1px dashed #333; padding: 8px; border-radius: 8px; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); border-radius: 10px; color: #fff; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-add { width: 100%; background: var(--accent); color: #fff; border: none; padding: 16px; border-radius: 14px; font-weight: bold; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); padding: 15px; border-top: 1px solid var(--border); }
        .btn-export { background: var(--success); color: #fff; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; }
    </style>
</head>
<body>

<div class="header">ISAQUE PRUSSAK SILVEIRA - VersÃ£o 16.4</div>

<div class="container">
    <div class="scanner-card"><div id="reader"></div></div>
    <div class="panel">
        <div id="prod-nome" class="product-name-display">PRONTO</div>
        <input type="text" id="barcode-res" placeholder="CÃ“DIGO" oninput="buscarProduto(this.value)">
        <input type="number" id="qtd" value="1" step="any">
        <button class="btn-add" onclick="adicionarItem()">REGISTRAR</button>
    </div>
    <div id="lista-corpo"></div>
</div>

<div class="footer">
    <button class="btn-export" onclick="exportarTXT()">ðŸ’¾ EXPORTAR INVENTARIO.TXT</button>
    <div style="text-align: center; font-size: 9px; color: #444; margin-top: 10px;">ISAQUE PRUSSAK SILVEIRA Â© 2026</div>
</div>

<script>
    let inventario = JSON.parse(localStorage.getItem('coleta_v16')) || [];
    let catalogo = [];

    // Carrega produtos do PRODUTO.TXT
    fetch('PRODUTO.TXT').then(r => r.text()).then(t => {
        catalogo = t.split('\n').filter(l => l.length > 13).map(l => ({
            code: l.substring(0, 13).trim().padStart(13, '0'),
            nome: l.substring(13).trim()
        }));
    });

    function buscarProduto(val) {
        const p = catalogo.find(i => i.code === val.trim().padStart(13, '0'));
        document.getElementById('prod-nome').innerText = p ? p.nome : "ITEM AVULSO";
    }

    function adicionarItem() {
        const code = document.getElementById('barcode-res').value.trim();
        const qtd = document.getElementById('qtd').value;
        if(!code) return;
        
        inventario.push({ code, qtd });
        localStorage.setItem('coleta_v16', JSON.stringify(inventario));
        atualizarTela();
        document.getElementById('barcode-res').value = "";
    }

    function atualizarTela() {
        document.getElementById('lista-corpo').innerHTML = inventario.map(i => 
            `<div style="padding:10px; border-bottom:1px solid #222;">${i.code} - ${i.qtd}</div>`
        ).join('');
    }

    function exportarTXT() {
        // CORREÃ‡ÃƒO CRÃTICA: Gera "Inventario" sem espaÃ§os iniciais
        let txt = inventario.map(i => `Inventario ${i.code} ${i.qtd}`).join("\r\n");
        const blob = new Blob([txt], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'inventario.txt';
        a.click();
    }

    const scanner = new Html5Qrcode("reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
        document.getElementById('barcode-res').value = text;
        buscarProduto(text);
        adicionarItem();
    });
    
    atualizarTela();
</script>
</body>
</html>
