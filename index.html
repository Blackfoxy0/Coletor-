<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor Pro - Estável</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; margin: 15px; background: #f4f4f9; }
        #reader { width: 100%; max-width: 450px; margin: auto; border-radius: 12px; overflow: hidden; border: 3px solid #007bff; min-height: 250px; background: #000; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; max-width: 450px; margin: 15px auto; }
        input, button { padding: 15px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-export { background: #28a745; }
        .btn-clear { background: #dc3545; font-size: 12px; }
        table { width: 100%; max-width: 450px; border-collapse: collapse; margin: 20px auto; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-family: monospace; }
        th { background: #007bff; color: white; font-family: sans-serif; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">Coletor Inventário</h2>
    <div id="reader"></div>

    <div class="controls">
        <input type="text" id="barcode-res" placeholder="Código de Barras">
        <input type="number" id="qtd" placeholder="Quantidade" value="1" onfocus="this.select()">
        <button onclick="adicionarOrSomar()">REGISTRAR / SOMAR</button>
        <hr>
        <button class="btn-export" onclick="exportarTXT()">GERAR INVENT.TXT</button>
        <button class="btn-clear" onclick="limparDados()">LIMPAR TUDO</button>
    </div>

    <table>
        <thead>
            <tr><th>Código (13 dgt)</th><th>Qtd</th></tr>
        </thead>
        <tbody id="corpo-tabela"></tbody>
    </table>

    <script>
        let inventario = JSON.parse(localStorage.getItem('coleta')) || [];
        const html5QrCode = new Html5Qrcode("reader");
        let cameraAtiva = false;

        // Função para INICIAR a câmera
        function ligarCamera() {
            if (cameraAtiva) return;
            html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 },
                (decodedText) => {
                    document.getElementById('barcode-res').value = decodedText;
                    if(navigator.vibrate) navigator.vibrate(100);
                }
            ).then(() => cameraAtiva = true)
             .catch(err => console.error("Erro na câmera", err));
        }

        // Função para DESLIGAR a câmera
        function desligarCamera() {
            if (cameraAtiva) {
                html5QrCode.stop().then(() => {
                    cameraAtiva = false;
                }).catch(err => console.error("Erro ao parar câmera", err));
            }
        }

        // MONITOR DE VISIBILIDADE: Resolve o travamento ao minimizar
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                desligarCamera(); // Para a câmera ao sair da aba
            } else {
                setTimeout(ligarCamera, 500); // Religa ao voltar (com atraso para o sistema liberar o hardware)
            }
        });

        function formatar13Digitos(valor) {
            return valor.toString().trim().padStart(13, '0');
        }

        function adicionarOrSomar() {
            let rawCode = document.getElementById('barcode-res').value.trim();
            if(!rawCode) return alert("Bipe ou digite um código.");
            
            const code = formatar13Digitos(rawCode);
            const qtd = parseInt(document.getElementById('qtd').value);
            
            if(isNaN(qtd)) return alert("Defina a quantidade.");

            const indexExistente = inventario.findIndex(item => item.code === code);
            if (indexExistente !== -1) {
                inventario[indexExistente].qtd = parseInt(inventario[indexExistente].qtd) + qtd;
            } else {
                inventario.push({ code, qtd });
            }

            salvarEAtualizar();
            document.getElementById('barcode-res').value = "";
            document.getElementById('qtd').value = "1";
        }

        function salvarEAtualizar() {
            localStorage.setItem('coleta', JSON.stringify(inventario));
            const corpo = document.getElementById('corpo-tabela');
            const listaReversa = [...inventario].reverse();
            corpo.innerHTML = listaReversa.map(i => `<tr><td>${i.code}</td><td>${i.qtd}</td></tr>`).join('');
        }

        function exportarTXT() {
            if(inventario.length === 0) return alert("Lista vazia.");
            let conteudo = "";
            for (let i = 0; i < inventario.length; i++) {
                let codigoFormatado = formatar13Digitos(inventario[i].code);
                conteudo += codigoFormatado + " " + inventario[i].qtd + "\r\n";
            }
            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invent.txt';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        function limparDados() {
            if(confirm("Apagar toda a lista?")) {
                inventario = [];
                salvarEAtualizar();
            }
        }

        // Inicialização
        salvarEAtualizar();
        ligarCamera();
    </script>
</body>
</html>
