<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Coletor Pro v38.6</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #050505; --card: #111115; --primary: #3b82f6; --accent: #60a5fa; 
            --success: #10b981; --danger: #ef4444; --border: rgba(255, 255, 255, 0.08); 
            --text: #fff; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-y: auto !important; }

        /* MENU INICIAL */
        #menu-inicial { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .menu-card { background: var(--card); border: 1px solid var(--border); padding: 35px; border-radius: 35px; width: 100%; max-width: 420px; text-align: center; }
        .menu-btn { width: 100%; padding: 20px; border-radius: 18px; border: none; font-weight: 900; font-size: 15px; color: white; margin-bottom: 12px; cursor: pointer; transition: var(--transition); }

        /* HEADER */
        #app-container { display: none; flex-direction: column; min-height: 100vh; }
        .header { position: sticky; top: 0; padding: 12px 20px; border-bottom: 1px solid var(--border); background: rgba(5,5,5,0.9); backdrop-filter: blur(15px); display: flex; justify-content: space-between; align-items: center; z-index: 5000; }

        /* CAMERA */
        .scanner-frame { position: relative; border-radius: 28px; overflow: hidden; border: 2px solid var(--border); background: #000; margin: 12px; transition: 0.4s; }
        .scanner-frozen { border-color: var(--primary); opacity: 0.5; filter: grayscale(1); }
        #reader { width: 100%; aspect-ratio: 16/10; }
        
        /* PAINEL */
        .main-panel { background: var(--card); border-radius: 28px; padding: 20px; margin: 0 12px 15px; border: 1px solid var(--border); position: relative; }
        .status-bar { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; text-align: center; margin-bottom: 10px; border: 1px solid var(--border); }
        
        .input-group { position: relative; display: flex; align-items: center; margin-bottom: 12px; }
        input { width: 100%; padding: 18px; background: rgba(255,255,255,0.04); border: 2px solid transparent; border-radius: 18px; color: #fff; font-size: 16px; font-weight: 600; }
        input:focus { border-color: var(--primary); }
        .btn-clear-input { position: absolute; right: 15px; background: #333; color: #fff; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; }

        /* LISTA */
        #lista-corpo { padding: 0 15px 330px 15px; }
        .item-card { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 22px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--primary); }
        .qtd-badge { background: rgba(59, 130, 246, 0.15); color: var(--primary); padding: 8px 12px; border-radius: 12px; font-weight: 900; font-size: 16px; cursor: pointer; }

        /* DASHBOARD */
        .dashboard { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(25px); padding: 22px; border-top: 1px solid var(--border); z-index: 5000; }
    </style>
</head>
<body>

<audio id="beep-sound" src="https://raw.githubusercontent.com/isaque-prussak/coletor/main/beep.mp3" preload="auto"></audio>

<div id="menu-inicial">
    <div class="menu-card">
        <h1 style="font-weight:900; margin-bottom:5px;">PRUSSAK PRO</h1>
        <p style="color:#666; font-size:10px; font-weight:900; margin-bottom:30px;">V38.6 ‚Ä¢ FULL SYSTEM</p>
        <button class="menu-btn" style="background:var(--primary)" onclick="mudarModo('INVENTARIO')">MODO INVENT√ÅRIO</button>
        <button class="menu-btn" style="background:#1a1a20; border:1px solid var(--border)" onclick="mudarModo('TROCA')">MODO TROCA / QUEBRA</button>
    </div>
</div>

<div id="app-container">
    <div class="header">
        <button onclick="voltarParaMenu()" style="background:none; border:none; color:#888; font-weight:900; font-size:11px;">‚¨Ö MENU</button>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="cam-status" style="color:var(--success); font-weight:900; font-size:11px;">C√ÇMERA ONLINE</div>
            <button onclick="location.reload()" style="background:none; border:none; color:var(--accent); font-weight:900; font-size:11px;">üîÑ ATUALIZAR</button>
        </div>
    </div>

    <div class="scanner-frame" id="frame-cam">
        <div id="reader"></div>
        <button onclick="ciclarCamera()" style="position:absolute; bottom:15px; right:15px; background:rgba(0,0,0,0.6); color:white; border:1px solid rgba(255,255,255,0.2); width:44px; height:44px; border-radius:50%; z-index:100;">üîÑ</button>
    </div>
    
    <div class="main-panel">
        <div class="status-bar"><b id="p-nome" style="font-size:12px; color:var(--accent)">AGUARDANDO...</b></div>
        <div class="input-group">
            <input type="text" id="barcode-res" placeholder="C√≥digo ou Nome" oninput="monitorarInput(this.value)" autocomplete="off">
            <button class="btn-clear-input" onclick="limparInput()">X</button>
        </div>
        <input type="text" id="qtd" value="1.000" inputmode="decimal" onfocus="this.select()">
        <button class="menu-btn" style="background:var(--primary); margin:0;" onclick="adicionarItem()">REGISTRAR</button>
    </div>

    <div id="lista-corpo"></div>

    <div class="dashboard">
        <div style="display:flex; justify-content:space-around; font-size:12px; font-weight:900; margin-bottom:15px;">
            <span>SKUS: <b id="st-skus">0</b></span>
            <span>TOTAL: <b id="st-total">0.000</b></span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="menu-btn" style="background:var(--success); flex:1; margin:0;" onclick="exportarTxt()">üíæ TXT</button>
            <button class="menu-btn" style="background:#25d366; flex:1; margin:0;" onclick="compartilharZap()">üü¢ WHATSAPP</button>
        </div>
        <center><button onclick="limparTudoManual()" style="background:none; border:none; color:var(--danger); font-size:11px; font-weight:900; margin-top:10px;">üóëÔ∏è LIMPAR LISTA ATUAL</button></center>
    </div>
</div>

<script>
    let modoGlobal = 'INVENTARIO';
    let inventario = JSON.parse(localStorage.getItem('coleta_atual')) || [];
    let catalogoMemo = [];
    let produtoAtivo = null;
    let html5QrCode = null;
    let camerasTraseiras = [];
    let camIdx = 0;
    let scanPausado = false;

    function tocarBip() { document.getElementById('beep-sound').play().catch(()=>{}); }

    function mudarModo(modo) {
        modoGlobal = modo;
        document.getElementById('menu-inicial').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        atualizarTela();
        iniciarHardware();
    }

    function limparInput() {
        document.getElementById('barcode-res').value = "";
        monitorarInput("");
    }

    function monitorarInput(val) {
        if(val.length === 0) {
            scanPausado = false;
            document.getElementById('frame-cam').classList.remove('scanner-frozen');
            document.getElementById('p-nome').innerText = "PRONTO";
            produtoAtivo = null;
        } else { buscaHibrida(val); }
    }

    function iniciarHardware() {
        Html5Qrcode.getCameras().then(devices => {
            camerasTraseiras = devices.filter(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('traseira') || d.label.toLowerCase().includes('0'));
            if(camerasTraseiras.length === 0) camerasTraseiras = devices;
            startCam(camerasTraseiras[camIdx].id);
        });
    }

    function startCam(id) {
        if(html5QrCode) html5QrCode.stop().then(() => doStart(id)); else doStart(id);
        function doStart(camId) {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(camId, { fps: 20, qrbox: 250 }, (t) => {
                if(scanPausado) return;
                scanPausado = true; tocarBip();
                document.getElementById('frame-cam').classList.add('scanner-frozen');
                let code = t.replace(/[^0-9]/g, "").padStart(13, '0');
                document.getElementById('barcode-res').value = code;
                buscaHibrida(code);
                document.getElementById('qtd').focus(); document.getElementById('qtd').select();
            });
        }
    }

    function ciclarCamera() { camIdx = (camIdx + 1) % camerasTraseiras.length; startCam(camerasTraseiras[camIdx].id); }

    async function carregarCatalogo() {
        try {
            const r = await fetch('PRODUTO.TXT');
            const t = await r.text();
            catalogoMemo = t.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                code: l.substring(0, 13).trim().padStart(13, '0'),
                nome: l.substring(13).slice(0, -10).trim()
            }));
        } catch(e) {}
    }

    function buscaHibrida(val) {
        let v = val.trim().toUpperCase();
        if(/^\d+$/.test(v)) {
            let vBusca = v.padStart(13, '0');
            const match = catalogoMemo.find(i => i.code === vBusca);
            produtoAtivo = match ? match : { code: vBusca, nome: "AVULSO" };
            document.getElementById('p-nome').innerText = produtoAtivo.nome;
        }
    }

    function adicionarItem() {
        let codeIn = document.getElementById('barcode-res').value.trim();
        let q = parseFloat(document.getElementById('qtd').value.replace(',','.'));
        if(!codeIn || isNaN(q)) return;
        let code = codeIn.padStart(13, '0');
        const idx = inventario.findIndex(i => i.code === code);
        if(idx !== -1) inventario[idx].qtd = (parseFloat(inventario[idx].qtd) + q).toFixed(3);
        else inventario.push({ code, nome: produtoAtivo ? produtoAtivo.nome : "AVULSO", qtd: q.toFixed(3) });
        localStorage.setItem('coleta_atual', JSON.stringify(inventario));
        atualizarTela();
        limparInput();
    }

    function editarQtd(index) {
        let nVal = prompt("Alterar Qtd:", inventario[index].qtd);
        if(nVal !== null) {
            let n = parseFloat(nVal.replace(',','.'));
            if(!isNaN(n)) { inventario[index].qtd = n.toFixed(3); localStorage.setItem('coleta_atual', JSON.stringify(inventario)); atualizarTela(); }
        }
    }

    function apagarItem(index) {
        if(confirm("Remover item?")) { inventario.splice(index, 1); localStorage.setItem('coleta_atual', JSON.stringify(inventario)); atualizarTela(); }
    }

    function atualizarTela() {
        let soma = 0;
        document.getElementById('lista-corpo').innerHTML = inventario.map((i, idx) => {
            soma += parseFloat(i.qtd);
            return `<div class="item-card"><div style="flex:1"><b style="color:var(--accent); display:block; font-size:13px;">${i.nome}</b><small style="color:#666">${i.code}</small></div><div style="text-align:right"><span class="qtd-badge" onclick="editarQtd(${idx})">${i.qtd}</span><button onclick="apagarItem(${idx})" style="background:none; border:none; color:var(--danger); font-weight:900; margin-left:8px;">üóëÔ∏è</button></div></div>`;
        }).reverse().join('');
        document.getElementById('st-skus').innerText = inventario.length;
        document.getElementById('st-total').innerText = soma.toFixed(3);
    }

    function exportarTxt() {
        if(inventario.length === 0) return;
        let txt = inventario.map(i => `${modoGlobal === 'INVENTARIO' ? 'Inventario ' : ''}${i.code} ${i.qtd}`).join("\r\n");
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt])); a.download = 'invent.txt'; a.click();
        setTimeout(() => { if(confirm("Deseja limpar a lista agora?")) limparTudoManual(); }, 1500);
    }

    async function compartilharZap() {
        if(inventario.length === 0) return;
        let txt = inventario.map(i => `${modoGlobal === 'INVENTARIO' ? 'Inventario ' : ''}${i.code} ${i.qtd}`).join("\r\n");
        const file = new File([txt], 'invent.txt', {type:'text/plain'});
        if(navigator.share) {
            try { await navigator.share({ files: [file] }); setTimeout(() => { if(confirm("Deseja limpar a lista agora?")) limparTudoManual(); }, 1000); } catch(e) {}
        }
    }

    function limparTudoManual() {
        inventario = []; localStorage.removeItem('coleta_atual'); atualizarTela();
    }

    function voltarParaMenu() {
        if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('menu-inicial').style.display = 'flex'; document.getElementById('app-container').style.display = 'none'; });
    }

    window.onload = carregarCatalogo;
</script>
</body>
</html>
