<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Apex Collector Enterprise</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #000000; --card: #121214; --primary: #0066ff; --accent: #00d1ff; 
            --success: #00e676; --warning: #ffab00; --danger: #ff3d00; --border: #262626;
            --text: #ffffff; --text-dim: #8e8e93;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        /* SVG ICONS */
        .icon { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* MENU INICIAL */
        #menu-inicial { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .menu-card { background: var(--card); border: 1px solid var(--border); padding: 50px 30px; border-radius: 40px; width: 100%; max-width: 420px; text-align: center; }
        
        .apex-header { margin-bottom: 40px; }
        .apex-logo-v { width: 48px; height: 48px; background: var(--primary); margin: 0 auto 15px; clip-path: polygon(50% 0%, 100% 100%, 50% 80%, 0% 100%); background: linear-gradient(180deg, var(--accent), var(--primary)); }
        .apex-title { font-weight: 800; font-size: 28px; letter-spacing: -1px; }

        .btn { width: 100%; padding: 20px; border-radius: 22px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); color: white; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .btn-main { background: var(--primary); }
        .btn-sec { background: #1c1c1e; border: 1px solid var(--border); }
        .btn:active { transform: scale(0.96); opacity: 0.8; }

        /* LAYOUT PRINCIPAL */
        #app-container { display: none; padding-bottom: 300px; }
        .header-nav { position: sticky; top: 0; padding: 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 9000; }

        /* CAMERA SYSTEM */
        .scan-module { position: relative; margin: 15px; height: 260px; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .scan-module.collapsed { height: 0; margin: 0; opacity: 0; overflow: hidden; }
        .scan-window { position: relative; border-radius: 35px; overflow: hidden; border: 2px solid var(--border); background: #000; height: 100%; transition: border 0.3s; }
        
        /* STATUS VISUAL FLASH */
        .scan-window.success { border-color: var(--success); box-shadow: 0 0 30px rgba(0,230,118,0.3); }
        .scan-window.not-found { border-color: var(--warning); box-shadow: 0 0 30px rgba(255,171,0,0.3); }
        
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover !important; }

        .cam-tools { position: absolute; bottom: 15px; right: 15px; left: 15px; display: flex; justify-content: space-between; z-index: 10; }
        .tool-btn { width: 48px; height: 48px; border-radius: 50%; background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.1); color: white; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }

        /* INPUT AREA */
        .input-module { background: var(--card); border-radius: 35px; padding: 25px; margin: 0 15px 15px; border: 1px solid var(--border); }
        .meta-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }
        
        .field-group { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 20px 24px; background: #000; border: 2px solid transparent; border-radius: 20px; color: #fff; font-size: 18px; font-weight: 600; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }

        /* RECENT LOG */
        .recent-log { margin: 0 25px 20px; font-size: 12px; color: var(--success); font-weight: 600; height: 20px; }

        /* LISTA */
        .list-container { padding: 0 15px; }
        .item-row { background: var(--card); padding: 20px; border-radius: 28px; margin-bottom: 10px; display: flex; align-items: center; border: 1px solid var(--border); animation: slideIn 0.4s ease-out; }
        .item-main { flex: 1; }
        .item-name { font-weight: 700; font-size: 15px; display: block; }
        .item-sub { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
        .item-qty { background: #1c1c1e; padding: 12px 18px; border-radius: 16px; color: var(--accent); font-weight: 800; border: 1px solid var(--border); font-size: 16px; }

        /* DASHBOARD */
        .footer-dash { position: fixed; bottom: 0; inset-x: 0; background: rgba(10,10,12,0.95); backdrop-filter: blur(30px); padding: 25px 25px 40px; border-top: 1px solid var(--border); z-index: 9500; }
        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .stat-box { border-left: 3px solid var(--primary); padding-left: 15px; }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; }
        .stat-value { font-size: 24px; font-weight: 800; display: block; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<audio id="beep-success" src="https://raw.githubusercontent.com/isaque-prussak/coletor/main/beep.mp3" preload="auto"></audio>
<input type="file" id="file-catalog" style="display:none" accept=".txt" onchange="apex.import(this)">

<div id="menu-inicial">
    <div class="menu-card">
        <div class="apex-header">
            <div class="apex-logo-v"></div>
            <div class="apex-title">APEX PRO</div>
            <div style="color:var(--text-dim); font-size: 12px; font-weight: 600; margin-top: 5px;">ENTERPRISE SOLUTION v45.0</div>
        </div>
        
        <button class="btn btn-main" onclick="apex.launch('INVENTARIO')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            INVENTÁRIO
        </button>
        <button class="btn btn-sec" onclick="apex.launch('TROCA')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            TROCA / QUEBRA
        </button>
        <button class="btn" style="background:none; color:var(--text-dim); font-size:13px;" onclick="document.getElementById('file-catalog').click()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            CARREGAR PRODUTO.TXT
        </button>
    </div>
</div>

<div id="app-container">
    <nav class="header-nav">
        <button onclick="apex.exit()" style="background:none; border:none; color:var(--text-dim); font-weight:700;">SAIR</button>
        <div class="apex-title" style="font-size:18px;">APEX</div>
        <button id="cam-status" onclick="apex.toggleCam()" style="background:var(--primary); border:none; color:white; font-size:10px; font-weight:800; padding:10px 16px; border-radius:15px;">CAM ON</button>
    </nav>

    <div class="scan-module" id="cam-block">
        <div class="scan-window" id="win-cam">
            <div id="reader"></div>
            <div class="cam-tools">
                <button class="tool-btn" onclick="apex.flipCam()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M4 4h16v16H4z M12 8v8 M8 12h8"/></svg>
                </button>
                <button class="tool-btn" onclick="apex.toggleTorch()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="recent-log" id="last-action"></div>
    
    <div class="input-module">
        <span class="meta-label" id="prod-label">IDENTIFICAÇÃO DO ITEM</span>
        <div class="field-group">
            <input type="text" id="in-barcode" placeholder="BIPE O CÓDIGO" oninput="apex.lookup(this.value)">
        </div>
        <div style="display:flex; gap:15px;">
            <input type="text" id="in-qty" value="1.000" inputmode="decimal" style="flex:1" onfocus="this.select()">
            <button class="btn btn-main" style="flex:1.3; margin:0;" onclick="apex.commit()">REGISTRAR</button>
        </div>
    </div>

    <div id="main-list" class="list-container"></div>

    <footer class="footer-dash">
        <div class="grid-stats">
            <div class="stat-box">
                <span class="stat-label">LINHAS</span>
                <span class="stat-value" id="count-skus">0</span>
            </div>
            <div class="stat-box" style="border-color: var(--accent);">
                <span class="stat-label">TOTAL UNID.</span>
                <span class="stat-value" id="count-total">0.000</span>
            </div>
        </div>
        <div style="display:flex; gap:15px;">
            <button class="btn btn-sec" style="flex:1; margin:0;" onclick="apex.download()">EXPORTAR TXT</button>
            <button class="btn" style="background:#25d366; flex:1; margin:0;" onclick="apex.sendZap()">WHATSAPP</button>
        </div>
    </footer>
</div>

<script>
    const apex = {
        core: { list: JSON.parse(localStorage.getItem('apex_db_v45')) || [], catalog: [], current: null, camActive: true, torch: false },
        hw: { scanner: null, devices: [], camIdx: 0 },

        async init() {
            try {
                const r = await fetch('PRODUTO.TXT');
                if(r.ok) this.process(await r.text());
            } catch(e) {}
            this.updateUI();
        },

        process(txt) {
            this.core.catalog = txt.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                c: l.substring(0, 13).trim().padStart(13, '0'),
                n: l.substring(13).slice(0, -10).trim()
            }));
        },

        import(i) {
            const r = new FileReader();
            r.onload = (e) => { this.process(e.target.result); alert("CATÁLOGO ENTERPRISE SINCRONIZADO"); };
            r.readAsText(i.files[0]);
        },

        launch(m) {
            this.core.mode = m;
            document.getElementById('menu-inicial').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            this.startCam();
        },

        toggleCam() {
            this.core.camActive = !this.core.camActive;
            const block = document.getElementById('cam-block');
            const status = document.getElementById('cam-status');
            if(this.core.camActive) {
                block.classList.remove('collapsed');
                status.innerText = "CAM ON";
                status.style.background = "var(--primary)";
                this.startCam();
            } else {
                block.classList.add('collapsed');
                status.innerText = "CAM OFF";
                status.style.background = "#333";
                if(this.hw.scanner) this.hw.scanner.stop();
            }
        },

        startCam() {
            Html5Qrcode.getCameras().then(d => {
                this.hw.devices = d.filter(c => /back|traseira|0/i.test(c.label)) || d;
                this.connect(this.hw.devices[this.hw.camIdx].id);
            });
        },

        connect(id) {
            if(this.hw.scanner) this.hw.scanner.stop().then(() => this.bind(id));
            else this.bind(id);
        },

        bind(id) {
            this.hw.scanner = new Html5Qrcode("reader");
            this.hw.scanner.start(id, { fps: 25, qrbox: {width: 260, height: 160}, aspectRatio: 1.77 }, (t) => {
                this.onScanSuccess(t);
            });
        },

        onScanSuccess(t) {
            const code = t.replace(/[^0-9]/g, "").padStart(13, '0');
            document.getElementById('in-barcode').value = code;
            this.lookup(code);
            
            // Haptic e Som
            document.getElementById('beep-success').play();
            if(navigator.vibrate) navigator.vibrate(120);

            // Foco quantidade
            document.getElementById('in-qty').focus();
        },

        lookup(v) {
            const win = document.getElementById('win-cam');
            if(!v) {
                win.className = "scan-window";
                document.getElementById('prod-label').innerText = "IDENTIFICAÇÃO DO ITEM";
                return;
            }
            const clean = v.trim().padStart(13, '0');
            const match = this.core.catalog.find(i => i.c === clean);
            
            if(match) {
                this.core.current = match;
                win.className = "scan-window success";
                document.getElementById('prod-label').innerText = match.n;
                document.getElementById('prod-label').style.color = "var(--success)";
            } else {
                this.core.current = { c: clean, n: "ITEM NÃO CADASTRADO" };
                win.className = "scan-window not-found";
                document.getElementById('prod-label').innerText = "PRODUTO NÃO NO CATÁLOGO";
                document.getElementById('prod-label').style.color = "var(--warning)";
            }
        },

        commit() {
            const c = document.getElementById('in-barcode').value.trim().padStart(13, '0');
            const q = parseFloat(document.getElementById('in-qty').value.replace(',','.'));
            if(!c || isNaN(q)) return;

            const idx = this.core.list.findIndex(i => i.c === c);
            if(idx !== -1) {
                this.core.list[idx].q = (parseFloat(this.core.list[idx].q) + q).toFixed(3);
            } else {
                this.core.list.push({ c, n: this.core.current ? this.core.current.n : "AVULSO", q: q.toFixed(3) });
            }

            document.getElementById('last-action').innerText = `Último: ${c} +${q}`;
            this.persist();
            this.resetForm();
        },

        persist() {
            localStorage.setItem('apex_db_v45', JSON.stringify(this.core.list));
            this.updateUI();
        },

        updateUI() {
            let total = 0;
            const html = this.core.list.map((it, i) => {
                total += parseFloat(it.q);
                return `<div class="item-row">
                    <div class="item-main">
                        <span class="item-name">${it.n}</span>
                        <span class="item-sub">${it.c}</span>
                    </div>
                    <div class="item-qty" onclick="apex.edit(${i})">${it.q}</div>
                    <button onclick="apex.drop(${i})" style="background:none; border:none; color:var(--danger); margin-left:15px;">✕</button>
                </div>`;
            }).reverse().join('');
            
            document.getElementById('main-list').innerHTML = html;
            document.getElementById('count-skus').innerText = this.core.list.length;
            document.getElementById('count-total').innerText = total.toFixed(3);
        },

        resetForm() {
            document.getElementById('in-barcode').value = "";
            document.getElementById('in-qty').value = "1.000";
            this.lookup("");
            document.getElementById('in-barcode').focus();
        },

        edit(i) {
            const v = prompt("EDITAR QUANTIDADE:", this.core.list[i].q);
            if(v) { this.core.list[i].q = parseFloat(v.replace(',','.')).toFixed(3); this.persist(); }
        },

        drop(i) { if(confirm("EXCLUIR REGISTRO?")) { this.core.list.splice(i,1); this.persist(); }},

        toggleTorch() {
            this.core.torch = !this.core.torch;
            if(this.hw.scanner) {
                this.hw.scanner.applyVideoConstraints({ focusMode: 'continuous', advanced: [{torch: this.core.torch}] })
                .catch(() => alert("LANTERNA NÃO SUPORTADA NESTE NAVEGADOR"));
            }
        },

        download() {
            const pre = this.core.mode === 'INVENTARIO' ? 'Inventario ' : '';
            const txt = this.core.list.map(i => `${pre}${i.c} ${i.q}`).join("\r\n");
            const b = new Blob([txt], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `APEX_EXPORT_${Date.now()}.txt`;
            a.click();
        },

        async sendZap() {
            const pre = this.core.mode === 'INVENTARIO' ? 'Inventario ' : '';
            const txt = this.core.list.map(i => `${pre}${i.c} ${i.q}`).join("\r\n");
            const f = new File([txt], 'apex_data.txt', {type:'text/plain'});
            if(navigator.share) await navigator.share({ files: [f] });
        },

        flipCam() {
            this.hw.camIdx = (this.hw.camIdx + 1) % this.hw.devices.length;
            this.connect(this.hw.devices[this.hw.camIdx].id);
        },

        exit() {
            if(this.hw.scanner) this.hw.scanner.stop();
            document.getElementById('menu-inicial').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    };
    window.onload = () => apex.init();
</script>
</body>
</html>
