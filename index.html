<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APEX TITANIUM v190</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #3b82f6; --bg: #000; --surface: #0a0a0b; --surface-2: #161618;
            --text: #fff; --mute: #6b7280; --border: #1e1e20; --success: #10b981; --error: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        header { padding: 45px 20px 10px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'Orbitron'; font-size: 18px; letter-spacing: 2px; }

        /* VIEWPORT OPTIMIZED */
        .viewport-wrapper { position: relative; width: 100%; height: 38vh; background: #000; overflow: hidden; }
        #reader { width: 100% !important; height: 100% !important; }
        
        .overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; border: 30px solid rgba(0,0,0,0.4); }
        .laser { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: var(--brand); box-shadow: 0 0 15px var(--brand); animation: scan 2s infinite ease-in-out; }
        @keyframes scan { 0%, 100% { transform: translateY(-30px); opacity: 0.3; } 50% { transform: translateY(30px); opacity: 1; } }

        /* CAM CONTROLS */
        .cam-ui { position: absolute; right: 15px; top: 15px; z-index: 100; display: flex; flex-direction: column; gap: 12px; }
        .icon-btn { background: rgba(0,0,0,0.7); border: 1px solid var(--border); color: #fff; width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); font-size: 18px; }

        /* CONTROL PANEL */
        .panel { flex: 1; padding: 15px 20px; background: var(--bg); border-top: 1px solid var(--border); overflow-y: auto; }
        .status-bar { text-align: center; margin-bottom: 12px; height: 18px; }
        .p-name { color: var(--brand); font-weight: 900; font-size: 13px; text-transform: uppercase; }

        .input-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px; }
        input { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 14px; color: #fff; text-align: center; font-size: 18px; font-weight: 700; transition: 0.2s; }
        input:focus { border-color: var(--brand); outline: none; background: var(--surface-2); }
        
        .btn-add { background: var(--brand); color: #fff; border: none; padding: 18px; border-radius: 16px; font-weight: 900; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; width: 100%; box-shadow: 0 4px 15px rgba(59,130,246,0.3); }

        /* SESSIONS & TOOLS */
        .tool-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
        .btn-tool { background: var(--surface-2); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 12px; font-size: 9px; font-weight: 800; }

        /* LIST */
        .list { margin-top: 20px; padding-bottom: 30px; }
        .entry { background: var(--surface); padding: 14px; border-radius: 18px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .qty-box { background: var(--brand); color: #fff; min-width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin-right: 12px; }

        .slogan { text-align: center; font-size: 8px; color: var(--mute); letter-spacing: 4px; margin-top: 20px; text-transform: uppercase; }

        #starter { position: fixed; inset: 0; z-index: 99999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="App.init()">

    <div id="starter">
        <div style="font-family:'Orbitron'; font-size:32px; color:var(--brand); margin-bottom:40px; text-shadow:0 0 20px var(--brand);">APEX TITANIUM</div>
        <button class="btn-add" style="width:auto; padding:20px 60px;">CARREGAR MOTOR</button>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100vh;">
        <header>
            <div class="logo">APEX <span style="color:var(--brand)">v190</span></div>
            <div id="cat-indicator" style="font-size:8px; color:var(--success)">OFFLINE</div>
        </header>

        <div class="viewport-wrapper">
            <div id="reader"></div>
            <div class="cam-ui">
                <button class="icon-btn" onclick="App.switchCam()">ðŸ”„</button>
                <button class="icon-btn" onclick="App.toggleFlash()">ðŸ”¦</button>
            </div>
            <div class="overlay"><div class="laser"></div></div>
        </div>

        <div class="panel">
            <div class="status-bar">
                <div id="display-name" class="p-name">AGUARDANDO SENSOR...</div>
            </div>

            <div class="input-grid">
                <input type="text" id="inp-code" placeholder="CÃ“DIGO" oninput="App.lookup(this.value)">
                <input type="number" id="inp-qty" value="1">
            </div>

            <button class="btn-add" onclick="App.confirm()">REGISTRAR ENTRADA</button>

            <div class="tool-bar">
                <button class="btn-tool" onclick="document.getElementById('f-cat').click()">IMPORTAR</button>
                <button class="btn-tool" onclick="App.export()">EXPORTAR</button>
                <button class="btn-tool" style="color:var(--error)" onclick="App.clear()">LIMPAR</button>
                <input type="file" id="f-cat" style="display:none" onchange="App.import(event)">
            </div>

            <div id="log" class="list"></div>
            
            <div class="slogan">InovaÃ§Ã£o em Movimento</div>
        </div>
    </div>

    <script>
        const App = {
            data: JSON.parse(localStorage.getItem('apex_db')) || [],
            cat: new Map(Object.entries(JSON.parse(localStorage.getItem('apex_cat')) || {})),
            scanner: null,
            cameras: [],
            camIdx: 0,
            flash: false,

            init() {
                document.getElementById('starter').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                this.startScanner();
                this.render();
            },

            async startScanner() {
                this.cameras = await Html5Qrcode.getCameras();
                if(this.cameras.length > 0) this.runCam(this.cameras[this.camIdx].id);
            },

            async runCam(id) {
                if(this.scanner) await this.scanner.stop();
                this.scanner = new Html5Qrcode("reader");
                await this.scanner.start(id, { fps: 30, qrbox: {width: 300, height: 150} }, (val) => {
                    this.process(val);
                });
            },

            async switchCam() {
                this.camIdx = (this.camIdx + 1) % this.cameras.length;
                this.runCam(this.cameras[this.camIdx].id);
            },

            async toggleFlash() {
                this.flash = !this.flash;
                try {
                    await this.scanner.applyVideoConstraints({ focusMode: 'continuous', advanced: [{torch: this.flash}] });
                } catch(e) { alert("Flash nÃ£o suportado nesta lente."); }
            },

            lookup(code) {
                const name = this.cat.get(code) || "ITEM NÃƒO CADASTRADO";
                document.getElementById('display-name').innerText = name;
            },

            process(code) {
                const qty = parseInt(document.getElementById('inp-qty').value) || 1;
                const item = this.data.find(i => i.code === code);
                
                if(item) item.qty += qty;
                else this.data.unshift({ code, qty, name: this.cat.get(code) || "Novo", time: new Date().toLocaleTimeString() });
                
                if(navigator.vibrate) navigator.vibrate(50);
                this.save();
                document.getElementById('inp-code').value = code;
                this.lookup(code);
            },

            confirm() {
                const code = document.getElementById('inp-code').value;
                if(code) {
                    this.process(code);
                    document.getElementById('inp-code').value = "";
                    document.getElementById('display-name').innerText = "AGUARDANDO SENSOR...";
                }
            },

            import(e) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n');
                    const obj = {};
                    lines.forEach(l => {
                        const [c, n] = l.split(',');
                        if(c && n) obj[c.trim()] = n.trim();
                    });
                    this.cat = new Map(Object.entries(obj));
                    localStorage.setItem('apex_cat', JSON.stringify(obj));
                    this.render();
                };
                reader.readAsText(e.target.files[0]);
            },

            save() {
                localStorage.setItem('apex_db', JSON.stringify(this.data));
                this.render();
            },

            export() {
                let csv = "CÃ“DIGO,NOME,QTD,HORA\n";
                this.data.forEach(i => csv += `${i.code},${i.name},${i.qty},${i.time}\n`);
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = "APEX_EXPORT.csv"; a.click();
            },

            clear() { if(confirm("Apagar todos os dados?")) { this.data = []; this.save(); } },

            render() {
                document.getElementById('cat-indicator').innerText = this.cat.size > 0 ? `${this.cat.size} ITENS` : "SEM CATÃLOGO";
                document.getElementById('log').innerHTML = this.data.map(i => `
                    <div class="entry">
                        <div style="display:flex; align-items:center">
                            <div class="qty-box">${i.qty}</div>
                            <div>
                                <div style="font-weight:900; font-size:13px">${i.name}</div>
                                <div style="font-size:10px; color:var(--mute)">${i.code} | ${i.time}</div>
                            </div>
                        </div>
                        <button onclick="App.data=App.data.filter(x=>x.code!='${i.code}');App.save()" style="background:none; border:none; color:var(--error); font-size:18px">âœ•</button>
                    </div>
                `).join('');
            }
        };
    </script>
</body>
</html>
