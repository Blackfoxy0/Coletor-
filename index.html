<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>Coletor Pro v52.1 - APK</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #050505; 
            --card-bg: rgba(30, 30, 35, 0.8);
            --primary: #3b82f6; 
            --accent: #60a5fa; 
            --success: #10b981; 
            --danger: #ef4444; 
            --border: rgba(255, 255, 255, 0.08); 
            --text: #fff; 
        }

        /* Ajuste de Scroll Nativo para APK */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
            touch-action: manipulation; /* Melhora resposta ao toque no APK */
        }

        html, body { 
            margin: 0; padding: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', sans-serif; 
            height: 100%;
            overflow: hidden; /* O body n√£o rola, quem rola √© o container da lista */
        }

        /* Estrutura Fixa para App */
        #app-container { 
            display: none; 
            flex-direction: column; 
            height: 100vh; 
            width: 100vw;
        }

        .header { 
            padding: env(safe-area-inset-top) 20px 12px; /* Ajuste para notch da c√¢mera */
            border-bottom: 1px solid var(--border); 
            background: rgba(5,5,5,0.95); 
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000;
        }

        /* C√¢mera Otimizada para o √Çngulo do APK */
        .scanner-frame { 
            position: relative; 
            margin: 10px; 
            border-radius: 24px; 
            overflow: hidden; 
            border: 2px solid var(--border);
            background: #000;
            flex-shrink: 0;
        }
        
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; } /* Garante que o v√≠deo preencha o √¢ngulo */

        /* Painel de Controle Principal */
        .main-panel { 
            background: var(--card-bg); 
            border-radius: 24px; 
            padding: 15px; 
            margin: 0 10px 10px; 
            border: 1px solid var(--border);
        }

        .input-wrapper {
            background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border); 
            border-radius: 15px;
            display: flex; align-items: center; margin-bottom: 10px;
        }

        input { 
            width: 100%; padding: 15px; 
            background: transparent; border: none; 
            color: #fff; font-size: 16px; font-weight: 600; 
        }

        /* Lista com Scroll Independente (Estilo App) */
        #lista-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 15px 350px; /* Espa√ßo para o Dashboard fixo */
            -webkit-overflow-scrolling: touch;
        }

        .item-card { 
            background: var(--card-bg); 
            padding: 15px; border-radius: 18px; 
            margin-bottom: 10px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            border-left: 5px solid var(--primary);
        }

        /* Dashboard Fixo no Rodap√© do APK */
        .dashboard { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(5,5,5,0.98); 
            padding: 20px 20px calc(env(safe-area-inset-bottom) + 15px);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(15px);
        }

        .btn-action {
            width: 100%; padding: 15px; border-radius: 15px;
            border: none; font-weight: 900; color: white;
            transition: 0.1s;
        }
        .btn-action:active { opacity: 0.8; transform: scale(0.98); }

        /* Estilo do Menu Inicial */
        #menu-inicial { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<audio id="beep-sound" src="https://raw.githubusercontent.com/isaque-prussak/coletor/main/beep.mp3" preload="auto"></audio>

<div id="menu-inicial">
    <div style="width: 85%; text-align: center;">
        <h1 style="font-weight:900; margin:0;">PRUSSAK PRO</h1>
        <p style="color:var(--accent); font-size:12px; font-weight:900; margin-bottom:40px;">V52.1 ‚Ä¢ APK STABLE</p>
        <button class="btn-action" style="background:var(--primary); margin-bottom:15px;" onclick="app.mudarModo('INVENTARIO')">MODO INVENT√ÅRIO</button>
        <button class="btn-action" style="background:#1a1a20; border:1px solid var(--border)" onclick="app.mudarModo('TROCA')">MODO TROCA / QUEBRA</button>
    </div>
</div>

<div id="app-container">
    <div class="header">
        <button onclick="app.voltarMenu()" style="background:none; border:none; color:#888; font-weight:900;">‚¨Ö MENU</button>
        <div id="cam-status" style="color:var(--success); font-weight:900; font-size:11px;">APP ONLINE</div>
    </div>

    <div class="scanner-frame">
        <div id="reader"></div>
        <button onclick="app.ciclarCamera()" style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.5); border:1px solid white; color:white; border-radius:50%; width:40px; height:40px; z-index:100;">üîÑ</button>
    </div>
    
    <div class="main-panel">
        <div id="p-nome" style="text-align:center; font-size:12px; color:var(--accent); margin-bottom:10px; font-weight:900;">PRONTO</div>
        <div class="input-wrapper">
            <input type="text" id="barcode-res" placeholder="C√≥digo ou Nome" oninput="app.monitorarInput(this.value)">
            <button onclick="app.limparInput()" style="background:none; border:none; color:#fff; padding:15px; font-weight:900;">‚úï</button>
        </div>
        <input type="text" id="qtd" value="1.000" inputmode="decimal" onfocus="this.select()" style="background:rgba(255,255,255,0.05); border-radius:15px; margin-bottom:10px; text-align:center;">
        <button class="btn-action" style="background:var(--primary)" onclick="app.adicionarItem()">REGISTRAR</button>
    </div>

    <div id="lista-container">
        <div id="lista-corpo"></div>
    </div>

    <div class="dashboard">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:900; font-size:13px;">
            <span>SKUS: <span id="st-skus">0</span></span>
            <span>TOTAL: <span id="st-total" style="color:var(--accent)">0.000</span></span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-action" style="background:var(--success); flex:1;" onclick="app.exportarTxt()">üíæ TXT</button>
            <button class="btn-action" style="background:#25d366; flex:1;" onclick="app.compartilharZap()">üü¢ WHATSAPP</button>
        </div>
        <center><button onclick="app.limparTudoManual()" style="background:none; border:none; color:var(--danger); font-size:11px; font-weight:900; margin-top:15px;">üóëÔ∏è DELETAR TUDO</button></center>
    </div>
</div>

<script>
const app = {
    dados: { modo: 'INVENTARIO', lista: JSON.parse(localStorage.getItem('coleta_v52')) || [], catalogo: [], produtoAtivo: null, scanPausado: false },
    hw: { scanner: null, cameras: [], camIdx: 0 },

    init: function() { 
        this.carregarCatalogo(); 
        this.renderLista();
    },

    carregarCatalogo: async function() {
        try {
            const r = await fetch('PRODUTO.TXT');
            const t = await r.text();
            this.dados.catalogo = t.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                code: l.substring(0, 13).trim().padStart(13, '0'),
                nome: l.substring(13).slice(0, -10).trim()
            }));
        } catch(e) {}
    },

    mudarModo: function(m) {
        this.dados.modo = m;
        document.getElementById('menu-inicial').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        this.iniciarCamera();
    },

    iniciarCamera: function() {
        Html5Qrcode.getCameras().then(devs => {
            this.hw.cameras = devs.filter(d => /back|traseira|0/i.test(d.label));
            if(this.hw.cameras.length === 0) this.hw.cameras = devs;
            this.ligarCamera(this.hw.cameras[this.hw.camIdx].id);
        });
    },

    ligarCamera: function(id) {
        if(this.hw.scanner) this.hw.scanner.stop().then(() => this.executar(id));
        else this.executar(id);
    },

    executar: function(id) {
        this.hw.scanner = new Html5Qrcode("reader");
        this.hw.scanner.start(id, { 
            fps: 25, 
            qrbox: (w, h) => ({ width: w * 0.9, height: h * 0.4 }),
            aspectRatio: 1.777
        }, (t) => {
            if(this.dados.scanPausado) return;
            this.dados.scanPausado = true;
            this.feedback();
            document.querySelector('.scanner-frame').classList.add('scanner-frozen');
            let code = t.replace(/[^0-9]/g, "").padStart(13, '0');
            document.getElementById('barcode-res').value = code;
            this.buscaHibrida(code);
            document.getElementById('qtd').focus();
            document.getElementById('qtd').select();
        });
    },

    ciclarCamera: function() {
        this.hw.camIdx = (this.hw.camIdx + 1) % this.hw.cameras.length;
        this.ligarCamera(this.hw.cameras[this.hw.camIdx].id);
    },

    monitorarInput: function(val) {
        if(val.length === 0) {
            this.dados.scanPausado = false;
            document.querySelector('.scanner-frame').classList.remove('scanner-frozen');
            document.getElementById('p-nome').innerText = "PRONTO";
        } else { this.buscaHibrida(val); }
    },

    limparInput: function() {
        document.getElementById('barcode-res').value = "";
        this.monitorarInput("");
    },

    buscaHibrida: function(val) {
        let v = val.trim().padStart(13, '0');
        const m = this.dados.catalogo.find(i => i.code === v);
        this.dados.produtoAtivo = m || { code: v, nome: "AVULSO" };
        document.getElementById('p-nome').innerText = this.dados.produtoAtivo.nome;
    },

    adicionarItem: function() {
        let code = document.getElementById('barcode-res').value.trim().padStart(13, '0');
        let q = parseFloat(document.getElementById('qtd').value.replace(',','.'));
        if(!code || isNaN(q)) return;
        
        const idx = this.dados.lista.findIndex(i => i.code === code);
        if(idx !== -1) this.dados.lista[idx].qtd = (parseFloat(this.dados.lista[idx].qtd) + q).toFixed(3);
        else this.dados.lista.push({ code, nome: this.dados.produtoAtivo?.nome || "AVULSO", qtd: q.toFixed(3) });
        
        this.salvar(); this.renderLista(); this.limparInput();
        document.getElementById('qtd').value = "1.000";
        if(navigator.vibrate) navigator.vibrate(40);
    },

    renderLista: function() {
        let soma = 0;
        document.getElementById('lista-corpo').innerHTML = this.dados.lista.map((it, idx) => {
            soma += parseFloat(it.qtd);
            return `<div class="item-card"><div><b>${it.nome}</b><br><small>${it.code}</small></div><div style="display:flex; align-items:center;"><span onclick="app.editar(${idx})" style="background:rgba(59,130,246,0.1); color:var(--accent); padding:10px; border-radius:10px; font-weight:900;">${it.qtd}</span><button onclick="app.remover(${idx})" style="background:none; border:none; color:var(--danger); margin-left:10px; font-weight:900;">‚úï</button></div></div>`;
        }).reverse().join('');
        document.getElementById('st-skus').innerText = this.dados.lista.length;
        document.getElementById('st-total').innerText = soma.toFixed(3);
    },

    editar: function(idx) {
        let n = prompt("Qtd:", this.dados.lista[idx].qtd);
        if(n) { this.dados.lista[idx].qtd = parseFloat(n.replace(',','.')).toFixed(3); this.salvar(); this.renderLista(); }
    },

    remover: function(idx) { if(confirm("Remover?")) { this.dados.lista.splice(idx,1); this.salvar(); this.renderLista(); } },

    salvar: function() { localStorage.setItem('coleta_v52', JSON.stringify(this.dados.lista)); },

    feedback: function() { 
        document.getElementById('beep-sound').play().catch(()=>{});
        if(navigator.vibrate) navigator.vibrate(60);
    },

    exportarTxt: function() {
        let t = this.dados.lista.map(i => `${this.dados.modo === 'INVENTARIO' ? 'Inventario ' : ''}${i.code} ${i.qtd}`).join("\r\n");
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t])); a.download = 'invent.txt'; a.click();
        setTimeout(() => { if(confirm("Zerar lista?")) this.limparTudoManual(); }, 1000);
    },

    compartilharZap: async function() {
        let t = this.dados.lista.map(i => `${this.dados.modo === 'INVENTARIO' ? 'Inventario ' : ''}${i.code} ${i.qtd}`).join("\r\n");
        const f = new File([t], 'invent.txt', {type:'text/plain'});
        if(navigator.share) { await navigator.share({ files: [f] }); this.limparTudoManual(); }
    },

    limparTudoManual: function() { this.dados.lista = []; this.salvar(); this.renderLista(); },

    voltarMenu: function() { if(this.hw.scanner) this.hw.scanner.stop().then(() => { document.getElementById('menu-inicial').style.display='flex'; document.getElementById('app-container').style.display='none'; }); }
};

window.onload = () => app.init();
</script>
</body>
</html>
