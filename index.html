<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Coletor Pro v34.2 - Master Control</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #121216; --primary: #3b82f6; --accent: #60a5fa; --success: #10b981; --danger: #ef4444; --border: rgba(255, 255, 255, 0.1); --text: #fff; --whatsapp: #25d366; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* MENU DE ENTRADA */
        #menu-inicial { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .menu-card { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 32px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        .menu-btn { width: 100%; padding: 22px; border-radius: 20px; border: none; font-weight: 900; font-size: 15px; cursor: pointer; margin-bottom: 12px; color: white; transition: 0.2s; text-align: center; }
        .btn-inv { background: var(--primary); }
        .btn-quebra { background: #222; border: 1px solid var(--border); }
        .menu-btn:active { transform: scale(0.96); opacity: 0.8; }

        /* INTERFACE PRINCIPAL */
        #app-container { display: none; height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; }
        
        /* BOT√ÉO VOLTAR */
        .btn-back { background: rgba(255,255,255,0.1); color: #fff; border: none; padding: 8px 12px; border-radius: 12px; font-size: 10px; font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-back:active { background: var(--danger); }

        .cam-master { background: #1a1a22; border-radius: 15px; padding: 6px 12px; font-size: 10px; font-weight: 900; border: 1px solid var(--border); }
        .cam-on { color: var(--success); border-color: var(--success); }
        .cam-off { color: var(--danger); border-color: var(--danger); }

        /* √ÅREA T√âCNICA */
        .scanner-container { padding: 8px; max-width: 500px; margin: 0 auto; width: 100%; }
        .scanner-frame { position: relative; border-radius: 24px; overflow: hidden; border: 1px solid var(--border); background: #000; transition: 0.4s ease; }
        #reader { width: 100%; aspect-ratio: 16/10; transition: 0.4s; }
        .cam-minimized { aspect-ratio: 100/1 !important; opacity: 0; pointer-events: none; }
        .cam-hidden { display: none !important; }

        .main-panel { background: var(--card); border-radius: 24px; padding: 15px; margin: 8px; border: 1px solid var(--border); position: relative; }
        .display-prod { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 12px; margin-bottom: 10px; text-align: center; border: 1px solid var(--border); min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .display-prod b { font-size: 11px; color: var(--accent); text-transform: uppercase; }
        
        input { width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 14px; color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        input:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }

        .suggestions { background: #1a1a22; border: 1px solid var(--primary); border-radius: 16px; position: absolute; width: calc(100% - 30px); z-index: 5000; max-height: 200px; overflow-y: auto; top: 115px; box-shadow: 0 20px 50px #000; }
        .sug-item { padding: 14px; border-bottom: 1px solid var(--border); }

        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 900; font-size: 14px; }

        #lista-corpo { flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 165px; }
        .item-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 18px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        .dashboard { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 15, 0.96); backdrop-filter: blur(20px); padding: 15px 15px calc(15px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border); z-index: 4000; }
        .stats-row { display: flex; justify-content: space-around; margin-bottom: 12px; font-size: 11px; }
        .btn-group { display: flex; gap: 8px; }
        .btn-exp { flex: 1; background: var(--success); border: none; padding: 14px; border-radius: 14px; color: white; font-weight: 900; }
        .btn-zap { flex: 1; background: var(--whatsapp); border: none; padding: 14px; border-radius: 14px; color: white; font-weight: 900; }
    </style>
</head>
<body>

<div id="menu-inicial">
    <div class="menu-card">
        <h2 style="margin:0 0 10px 0; font-weight: 900;">COLETOR PRO</h2>
        <p style="color: #666; font-size: 12px; margin-bottom: 25px;">Escolha a finalidade da coleta:</p>
        <button class="menu-btn btn-inv" onclick="mudarModo('INVENTARIO')">MODO INVENT√ÅRIO<br><small style="font-weight: 400; font-size: 9px; opacity: 0.7;">Prefixo: Inventario [c√≥digo]</small></button>
        <button class="menu-btn btn-quebra" onclick="mudarModo('TROCA')">TROCA / QUEBRA<br><small style="font-weight: 400; font-size: 9px; opacity: 0.7;">Sem prefixo: [c√≥digo]</small></button>
        <p style="font-size: 10px; color: #444; margin-top: 20px;">v34.2 ‚Ä¢ PROGRESS 2012 READY</p>
    </div>
</div>

<div id="app-container">
    <div class="header">
        <button class="btn-back" onclick="voltarAoMenu()">‚¨Ö MENU</button>
        <div id="cam-status" class="cam-master cam-on" onclick="toggleHardwareCam()">CAM: ON</div>
    </div>

    <div class="scanner-container">
        <div class="scanner-frame" id="frame-cam">
            <div id="reader"></div>
        </div>
        
        <div class="main-panel">
            <div class="display-prod"><b id="p-nome">PRONTO PARA COLETAR</b></div>
            <input type="text" id="barcode-res" placeholder="C√ìDIGO OU NOME" 
                   onfocus="toggleCamView(true)" 
                   onblur="setTimeout(()=>toggleCamView(false), 300)"
                   oninput="limparInput(this); buscaHibrida(this.value)" autocomplete="off">
            <div id="suggestions-box" class="suggestions" style="display:none"></div>
            <input type="text" id="qtd" value="1.000" inputmode="decimal" oninput="limparQtd(this)" onfocus="this.select()">
            <button class="btn-main" onclick="adicionarItem()">REGISTRAR</button>
        </div>
    </div>

    <div id="lista-corpo"></div>

    <div class="dashboard">
        <div class="stats-row">
            <span>MODO ATIVO: <b id="txt-modo" style="color:var(--primary)">-</b></span>
            <span>SKUS: <b id="st-skus">0</b></span>
            <span>TOTAL: <b id="st-total">0.000</b></span>
        </div>
        <div class="btn-group">
            <button class="btn-exp" onclick="exportarTxt()">üíæ BAIXAR .TXT</button>
            <button class="btn-zap" onclick="compartilharZap()">üü¢ WHATSAPP</button>
        </div>
        <div style="text-align: center; margin-top: 8px;">
            <button onclick="limparListaCompleta()" style="background:none; border:none; color:var(--danger); font-size:10px; font-weight:bold; letter-spacing:1px;">LIMPAR TUDO</button>
        </div>
    </div>
</div>

<script>
    let modoGlobal = 'INVENTARIO';
    let inventario = JSON.parse(localStorage.getItem('coleta_v34_data')) || [];
    let catalogoMemo = [];
    let produtoAtivo = null;
    let html5QrCode = null;
    let camHabilitada = true;

    // NOVO RECURSO: TROCA DE MODO DIN√ÇMICA
    function mudarModo(modo) {
        modoGlobal = modo;
        document.getElementById('menu-inicial').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('txt-modo').innerText = modo;
        atualizarTela();
        iniciarHardware();
    }

    function voltarAoMenu() {
        if(html5QrCode) html5QrCode.stop().then(() => {
            document.getElementById('menu-inicial').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        });
        else {
            document.getElementById('menu-inicial').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    }

    function toggleHardwareCam() {
        camHabilitada = !camHabilitada;
        const btn = document.getElementById('cam-status');
        const frame = document.getElementById('frame-cam');
        if(camHabilitada) {
            btn.className = "cam-master cam-on"; btn.innerText = "CAM: ON";
            frame.classList.remove('cam-hidden'); iniciarHardware();
        } else {
            btn.className = "cam-master cam-off"; btn.innerText = "CAM: OFF";
            frame.classList.add('cam-hidden'); if(html5QrCode) html5QrCode.stop();
        }
    }

    function toggleCamView(min) {
        if(!camHabilitada) return;
        const r = document.getElementById('reader');
        if(min) r.classList.add('cam-minimized');
        else r.classList.remove('cam-minimized');
    }

    function limparInput(el) { el.value = el.value.replace(/[^a-zA-Z0-9 ]/g, ""); }
    function limparQtd(el) { el.value = el.value.replace(/[^0-9.]/g, ""); }

    async function carregarCatalogo() {
        try {
            const r = await fetch('PRODUTO.TXT', {cache: "no-store"});
            const t = await r.text();
            catalogoMemo = t.split(/\r?\n/).filter(l => l.length > 13).map(l => ({
                code: l.substring(0, 13).trim().padStart(13, '0'),
                nome: l.substring(13).slice(0, -10).trim()
            }));
        } catch(e) {}
    }

    function iniciarHardware() {
        if(!camHabilitada) return;
        Html5Qrcode.getCameras().then(devices => {
            const back = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('traseira')) || devices[0];
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(back.id, { fps: 20, qrbox: 250 }, (t) => {
                let code = t.replace(/[^0-9]/g, "");
                document.getElementById('barcode-res').value = code;
                buscaHibrida(code);
                document.getElementById('qtd').focus();
            });
        });
    }

    function buscaHibrida(val) {
        let v = val.trim().toUpperCase();
        const box = document.getElementById('suggestions-box');
        if(v.length < 2) { box.style.display = 'none'; return; }
        if(/^\d+$/.test(v)) {
            let vBusca = v.padStart(13, '0');
            const match = catalogoMemo.find(i => i.code === vBusca);
            produtoAtivo = match ? match : { code: vBusca, nome: "PRODUTO AVULSO" };
            document.getElementById('p-nome').innerText = produtoAtivo.nome;
            box.style.display = 'none';
        } else {
            const res = catalogoMemo.filter(i => i.nome.includes(v)).slice(0, 10);
            box.innerHTML = res.map(i => `<div class="sug-item" onmousedown="selecionar('${i.code}','${i.nome}')"><b>${i.nome}</b><small style="color:var(--primary)">${i.code}</small></div>`).join('');
            box.style.display = res.length > 0 ? 'block' : 'none';
        }
    }

    function selecionar(c, n) {
        produtoAtivo = { code: c, nome: n };
        document.getElementById('barcode-res').value = c;
        document.getElementById('p-nome').innerText = n;
        document.getElementById('suggestions-box').style.display = 'none';
        setTimeout(() => document.getElementById('qtd').focus(), 150);
    }

    function adicionarItem() {
        let code = document.getElementById('barcode-res').value.trim();
        let qVal = document.getElementById('qtd').value.replace(',','.');
        let q = parseFloat(qVal);
        if(!code || isNaN(q)) return;
        if(/^\d+$/.test(code)) code = code.padStart(13, '0');
        
        const idx = inventario.findIndex(i => i.code === code);
        if(idx !== -1) inventario[idx].qtd = (parseFloat(inventario[idx].qtd) + q).toFixed(3);
        else inventario.push({ code, nome: produtoAtivo ? produtoAtivo.nome : "AVULSO", qtd: q.toFixed(3) });
        
        localStorage.setItem('coleta_v34_data', JSON.stringify(inventario));
        atualizarTela();
        document.getElementById('barcode-res').value = "";
        document.getElementById('qtd').value = "1.000";
        document.getElementById('barcode-res').focus();
        document.getElementById('p-nome').innerText = "REGISTRADO";
    }

    function atualizarTela() {
        let soma = 0;
        document.getElementById('lista-corpo').innerHTML = [...inventario].reverse().map(i => {
            soma += parseFloat(i.qtd);
            return `<div class="item-card"><div><small style="font-size:9px; color:#666;">${i.nome}</small><br><b>${i.code}</b></div><b>${i.qtd}</b></div>`;
        }).join('');
        document.getElementById('st-skus').innerText = inventario.length;
        document.getElementById('st-total').innerText = soma.toFixed(3);
    }

    function formatarFinal() {
        return inventario.map(i => {
            let prefixo = modoGlobal === 'INVENTARIO' ? 'Inventario ' : '';
            return `${prefixo}${i.code} ${parseFloat(i.qtd).toFixed(3)}`;
        }).join("\r\n");
    }

    function exportarTxt() {
        if(inventario.length === 0) return;
        const blob = new Blob([formatarFinal()], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'invent.txt'; a.click();
    }

    async function compartilharZap() {
        if(inventario.length === 0) return;
        const file = new File([formatarFinal()], 'invent.txt', { type: 'text/plain' });
        if(navigator.share) await navigator.share({ files: [file], title: 'Coleta Progress' });
    }

    function limparListaCompleta() {
        if(confirm("Deseja apagar toda a coleta atual?")) {
            inventario = [];
            localStorage.removeItem('coleta_v34_data');
            atualizarTela();
        }
    }

    window.onload = carregarCatalogo;
</script>
</body>
</html>
