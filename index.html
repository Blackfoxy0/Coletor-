<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APEX TITANIUM v160</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #3b82f6; --bg: #000; --surface: #0a0a0b; --surface-2: #161618;
            --text: #fff; --mute: #6b7280; --border: #1e1e20; --success: #10b981; --error: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* INTRO CINEMATOGR√ÅFICA */
        #intro-screen { position: fixed; inset: 0; background: #000; z-index: 10001; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .intro-logo { font-family: 'Orbitron'; font-size: 40px; color: var(--brand); letter-spacing: 12px; text-shadow: 0 0 40px var(--brand); animation: zoom 3s infinite alternate; }
        @keyframes zoom { from { transform: scale(0.95); opacity: 0.8; } to { transform: scale(1.05); opacity: 1; } }
        
        /* HEADER & SESSIONS */
        header { padding: 50px 20px 10px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .session-tabs { display: flex; gap: 8px; overflow-x: auto; padding: 10px; background: var(--surface-2); scrollbar-width: none; border-bottom: 1px solid var(--border); }
        .tab { background: var(--surface); border: 1px solid var(--border); color: var(--mute); padding: 8px 16px; border-radius: 12px; font-size: 10px; font-weight: 800; white-space: nowrap; transition: 0.3s; }
        .tab.active { background: var(--brand); color: white; border-color: var(--brand); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

        /* SCANNER & VIEWPORT */
        .viewport { padding: 12px; position: relative; }
        #reader { height: 190px; border-radius: 24px; overflow: hidden; background: #000; border: 2px solid var(--border); position: relative; }
        .laser { position: absolute; left: 5%; width: 90%; height: 2px; background: var(--brand); box-shadow: 0 0 15px var(--brand); z-index: 10; animation: scanning 2s infinite ease-in-out; }
        @keyframes scanning { 0%, 100% { top: 20%; opacity: 0.2; } 50% { top: 80%; opacity: 1; } }

        /* CONTROL PANEL */
        .panel { padding: 10px 18px; }
        .display-card { background: var(--surface); padding: 20px; border-radius: 28px; border: 1px solid var(--border); }
        .info-box { background: var(--surface-2); padding: 12px; border-radius: 16px; margin-bottom: 12px; text-align: center; border: 1px dashed var(--border); }
        .name-label { color: var(--brand); font-weight: 900; font-size: 14px; text-transform: uppercase; }

        .input-row { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 12px; }
        input { background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 14px; color: var(--text); font-weight: 700; text-align: center; font-size: 18px; }
        
        .btn-confirm { background: var(--brand); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 900; width: 100%; text-transform: uppercase; font-size: 14px; }
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
        .btn-t { background: var(--surface-2); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 12px; font-size: 9px; font-weight: 800; }

        /* LISTING */
        .log-container { flex: 1; overflow-y: auto; padding: 10px 18px; }
        .item-card { background: var(--surface); padding: 14px; border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; animation: pop 0.3s ease; }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } }
        .qty-tag { background: var(--brand); width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 900; margin-right: 12px; }

        #cam-lock { position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="App.initAudio()">

    <div id="intro-screen">
        <div class="intro-logo">APEX</div>
        <p style="color:var(--mute); font-size:10px; margin-top:15px; letter-spacing:4px;">TAP TO START</p>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100vh;">
        <header>
            <div style="font-family:'Orbitron'; font-size:16px;">APEX <span style="color:var(--brand)">SCAN</span></div>
            <div id="cat-count" style="font-size:9px; color:var(--success); font-weight:900;">CAT√ÅLOGO OFFLINE</div>
        </header>

        <div class="session-tabs" id="tabs"></div>

        <div class="viewport">
            <div id="reader">
                <div class="laser"></div>
                <div id="cam-lock">
                    <button class="btn-confirm" style="width:auto; padding:12px 30px;" onclick="App.startCamera()">LIGAR C√ÇMERA</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="display-card">
                <div class="info-box">
                    <div id="p-name" class="name-label">AGUARDANDO...</div>
                </div>
                <div class="input-row">
                    <input type="text" id="p-code" placeholder="C√ìDIGO" oninput="App.lookup(this.value)">
                    <input type="number" id="p-qty" value="1">
                </div>
                <button class="btn-confirm" onclick="App.add()">CONFIRMAR REGISTO</button>
                
                <div class="tool-grid">
                    <button class="btn-t" onclick="document.getElementById('file').click()">üì• CAT√ÅLOGO</button>
                    <button class="btn-t" onclick="App.export()">üì§ EXPORTAR</button>
                    <button class="btn-t" onclick="App.newSess()">üìÇ NOVA</button>
                </div>
                <input type="file" id="file" style="display:none" accept=".csv,.txt" onchange="App.import(event)">
            </div>
        </div>

        <div id="log" class="log-container"></div>
    </div>

    <script>
        const App = {
            db: JSON.parse(localStorage.getItem('apex_v160_db')) || { "SESS√ÉO 01": [] },
            cat: JSON.parse(localStorage.getItem('apex_v160_cat')) || {},
            current: localStorage.getItem('apex_v160_curr') || "SESS√ÉO 01",
            ctx: null,

            initAudio() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    document.getElementById('intro-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('intro-screen').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';
                        this.render();
                    }, 800);
                }
            },

            beep(f, d) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                o.frequency.value = f; g.gain.value = 0.1;
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
                o.start(); o.stop(this.ctx.currentTime + d);
            },

            async startCamera() {
                this.beep(800, 0.1);
                document.getElementById('cam-lock').style.display = 'none';
                try {
                    const scanner = new Html5Qrcode("reader");
                    await scanner.start({ facingMode: "environment" }, { fps: 30, qrbox: 250 }, (val) => {
                        document.getElementById('p-code').value = val;
                        this.lookup(val);
                        this.beep(1200, 0.1);
                        if(navigator.vibrate) navigator.vibrate(60);
                        this.add(val);
                    });
                } catch (e) {
                    alert("Erro de permiss√£o! Ative a c√¢mara nas defini√ß√µes.");
                }
            },

            import(e) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n');
                    this.cat = {};
                    lines.forEach(l => {
                        const [c, n] = l.split(',');
                        if(c && n) this.cat[c.trim()] = n.trim();
                    });
                    localStorage.setItem('apex_v160_cat', JSON.stringify(this.cat));
                    this.render();
                    alert("Cat√°logo Ativado!");
                };
                reader.readAsText(e.target.files[0]);
            },

            lookup(c) {
                const name = this.cat[c] || "PRODUTO NOVO";
                document.getElementById('p-name').innerText = name;
                return name;
            },

            add(scannedCode = null) {
                const code = scannedCode || document.getElementById('p-code').value;
                const qty = parseInt(document.getElementById('p-qty').value) || 1;
                if(!code) return;

                const session = this.db[this.current];
                const item = session.find(i => i.code === code);
                
                if(item) {
                    item.qty += qty;
                } else {
                    session.unshift({ code, qty, name: this.cat[code] || "Novo", time: new Date().toLocaleTimeString() });
                }

                this.save();
                if(!scannedCode) {
                    document.getElementById('p-code').value = "";
                    document.getElementById('p-qty').value = "1";
                    document.getElementById('p-name').innerText = "AGUARDANDO...";
                }
            },

            edit(code) {
                const n = prompt("Nova quantidade:");
                if(n !== null) {
                    const item = this.db[this.current].find(i => i.code === code);
                    item.qty = parseInt(n) || 0;
                    this.save();
                }
            },

            newSess() {
                const n = prompt("Nome da Sess√£o:");
                if(n) { this.db[n] = []; this.current = n; this.save(); }
            },

            save() {
                localStorage.setItem('apex_v160_db', JSON.stringify(this.db));
                localStorage.setItem('apex_v160_curr', this.current);
                this.render();
            },

            export() {
                let txt = `RELATORIO APEX - ${this.current}\n\nCODIGO,NOME,QTD,HORA\n`;
                this.db[this.current].forEach(i => txt += `${i.code},${i.name},${i.qty},${i.time}\n`);
                const b = new Blob([txt], {type: 'text/plain'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b);
                a.download = `${this.current}.txt`; a.click();
            },

            render() {
                const cSize = Object.keys(this.cat).length;
                document.getElementById('cat-count').innerText = cSize > 0 ? `${cSize} ITENS NO CAT√ÅLOGO` : "CAT√ÅLOGO VAZIO";
                
                document.getElementById('tabs').innerHTML = Object.keys(this.db).map(n => `
                    <div class="tab ${n === this.current ? 'active' : ''}" onclick="App.current='${n}';App.save()">${n}</div>
                `).join('');

                document.getElementById('log').innerHTML = this.db[this.current].map(i => `
                    <div class="item-card" onclick="App.edit('${i.code}')">
                        <div style="display:flex; align-items:center">
                            <div class="qty-tag">${i.qty}</div>
                            <div>
                                <div style="font-size:13px; font-weight:900">${i.name}</div>
                                <div style="font-size:10px; color:var(--mute)">${i.code} ‚Ä¢ ${i.time}</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); App.db['${this.current}'] = App.db['${this.current}'].filter(x=>x.code!='${i.code}'); App.save()" style="background:none; border:none; color:var(--error); font-size:18px">‚úï</button>
                    </div>
                `).join('');
            }
        };
    </script>
</body>
</html>
